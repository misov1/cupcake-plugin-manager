{"versions":{"CPM Provider - Vertex AI":{"version":"1.3.0","file":"cpm-provider-vertex.js"},"CPM Provider - Gemini Studio":{"version":"1.3.0","file":"cpm-provider-gemini.js"},"CPM Provider - Anthropic":{"version":"1.5.0","file":"cpm-provider-anthropic.js"},"CPM Provider - OpenAI":{"version":"1.4.0","file":"cpm-provider-openai.js"},"CPM Provider - DeepSeek":{"version":"1.3.0","file":"cpm-provider-deepseek.js"},"CPM Provider - OpenRouter":{"version":"1.2.0","file":"cpm-provider-openrouter.js"},"CPM Provider - AWS Bedrock":{"version":"1.4.0","file":"cpm-provider-aws.js"},"CPM Component - Chat Input Resizer":{"version":"0.1.4","file":"cpm-chat-resizer.js"},"CPM Component - Copilot Token Manager":{"version":"1.5.0","file":"cpm-copilot-manager.js"},"CPM Component - Translation Cache Manager":{"version":"1.1.1","file":"cpm-translation-cache.js"}},"code":{"cpm-provider-vertex.js":"// @name CPM Provider - Vertex AI\r\n// @version 1.3.0\r\n// @description Google Vertex AI (Service Account) provider for Cupcake PM (Streaming)\r\n// @icon ðŸ”·\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-vertex.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-Vertex] CupcakePM API not found!'); return; }\r\n\r\n    // Shared Gemini model IDs available on Vertex\r\n    const GEMINI_MODELS = [\r\n        { id: 'gemini-3-pro-preview', name: 'Gemini 3 Pro Preview' },\r\n        { id: 'gemini-3.1-pro-preview', name: 'Gemini 3.1 Pro Preview' },\r\n        { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash Preview' },\r\n        { id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro' },\r\n        { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash' },\r\n    ];\r\n    const VERTEX_ONLY_MODELS = [\r\n        { id: 'gemini-3-pro-image-preview', name: 'Gemini 3 Pro Image Preview' },\r\n    ];\r\n    const CLAUDE_ON_VERTEX = [\r\n        { baseId: \"claude-haiku-4-5\", date: \"20251001\", name: \"Claude 4.5 Haiku\", displayDate: \"2025/10/01\" },\r\n        { baseId: \"claude-sonnet-4\", date: \"20250514\", name: \"Claude 4 Sonnet\", displayDate: \"2025/05/14\" },\r\n        { baseId: \"claude-sonnet-4-5\", date: \"20250929\", name: \"Claude 4.5 Sonnet\", displayDate: \"2025/09/29\" },\r\n        { baseId: \"claude-opus-4-1\", date: \"20250805\", name: \"Claude 4.1 Opus\", displayDate: \"2025/08/05\" },\r\n        { baseId: \"claude-opus-4-5\", date: \"20251101\", name: \"Claude 4.5 Opus\", displayDate: \"2025/11/01\" },\r\n    ];\r\n\r\n    const models = [];\r\n    GEMINI_MODELS.forEach(m => models.push({ uniqueId: `vertex-${m.id}`, id: m.id, name: m.name }));\r\n    VERTEX_ONLY_MODELS.forEach(m => models.push({ uniqueId: `vertex-${m.id}`, id: m.id, name: m.name }));\r\n    CLAUDE_ON_VERTEX.forEach(m => models.push({\r\n        uniqueId: `vertex-${m.baseId}`,\r\n        id: `${m.baseId}@${m.date}`,\r\n        name: `${m.name} (${m.displayDate})`\r\n    }));\r\n\r\n    // Vertex OAuth token helper (uses Service Account JSON key)\r\n    async function getVertexAccessToken(keyJson) {\r\n        const cache = CPM.vertexTokenCache || { token: null, expiry: 0 };\r\n        const now = Math.floor(Date.now() / 1000);\r\n        if (cache.token && cache.expiry > now + 60) return cache.token;\r\n\r\n        const key = JSON.parse(keyJson);\r\n        const header = btoa(JSON.stringify({ alg: 'RS256', typ: 'JWT' })).replace(/=+$/, '');\r\n        const claims = btoa(JSON.stringify({\r\n            iss: key.client_email,\r\n            scope: 'https://www.googleapis.com/auth/cloud-platform',\r\n            aud: 'https://oauth2.googleapis.com/token',\r\n            iat: now, exp: now + 3600\r\n        })).replace(/=+$/, '');\r\n        const unsignedToken = `${header}.${claims}`;\r\n        const binaryKey = atob(key.private_key.replace(/-----BEGIN .*?-----/g, '').replace(/-----END .*?-----/g, '').replace(/\\s/g, ''));\r\n        const bytes = new Uint8Array(binaryKey.length);\r\n        for (let i = 0; i < binaryKey.length; i++) bytes[i] = binaryKey.charCodeAt(i);\r\n        const privateKey = await crypto.subtle.importKey('pkcs8', bytes.buffer, { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' }, false, ['sign']);\r\n        const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', privateKey, new TextEncoder().encode(unsignedToken));\r\n        const sigB64 = btoa(String.fromCharCode(...new Uint8Array(signature))).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\r\n        const jwt = `${unsignedToken}.${sigB64}`;\r\n\r\n        const res = await Risuai.nativeFetch('https://oauth2.googleapis.com/token', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\r\n            body: `grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${jwt}`\r\n        });\r\n        if (!res.ok) throw new Error(await res.text());\r\n        const data = await res.json();\r\n        CPM.vertexTokenCache = { token: data.access_token, expiry: now + data.expires_in };\r\n        return data.access_token;\r\n    }\r\n\r\n    CPM.registerProvider({\r\n        name: 'VertexAI',\r\n        models,\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const keyJson = await CPM.safeGetArg('cpm_vertex_key_json');\r\n                if (!keyJson) return null;\r\n                const loc = await CPM.safeGetArg('cpm_vertex_location') || 'us-central1';\r\n                const accessToken = await getVertexAccessToken(keyJson);\r\n                const key = JSON.parse(keyJson);\r\n                const project = key.project_id;\r\n                const baseUrl = loc === 'global' ? 'https://aiplatform.googleapis.com' : `https://${loc}-aiplatform.googleapis.com`;\r\n\r\n                // Fetch Gemini models from Vertex\r\n                let allModels = [];\r\n                let pageToken = null;\r\n                while (true) {\r\n                    let url = `${baseUrl}/v1beta1/publishers/google/models?pageSize=100`;\r\n                    if (pageToken) url += `&pageToken=${encodeURIComponent(pageToken)}`;\r\n                    const res = await CPM.smartFetch(url, {\r\n                        method: 'GET',\r\n                        headers: { 'Authorization': `Bearer ${accessToken}` }\r\n                    });\r\n                    if (!res.ok) break;\r\n                    const data = await res.json();\r\n                    if (data.models) allModels = allModels.concat(data.models);\r\n                    if (!data.nextPageToken) break;\r\n                    pageToken = data.nextPageToken;\r\n                }\r\n\r\n                const result = [];\r\n                // Process Gemini models\r\n                for (const m of allModels) {\r\n                    const id = (m.name || '').split('/').pop();\r\n                    if (!id) continue;\r\n                    // Only include gemini models that support generateContent\r\n                    if (!id.startsWith('gemini-')) continue;\r\n                    if (m.supportedActions && !m.supportedActions.includes('generateContent')) continue;\r\n                    result.push({\r\n                        uniqueId: `vertex-${id}`,\r\n                        id: id,\r\n                        name: m.displayName || id\r\n                    });\r\n                }\r\n\r\n                // Also list Claude models available via Vertex (Model Garden)\r\n                // These use a different endpoint pattern\r\n                try {\r\n                    const claudeUrl = `${baseUrl}/v1beta1/projects/${project}/locations/${loc}/publishers/anthropic/models`;\r\n                    const claudeRes = await CPM.smartFetch(claudeUrl, {\r\n                        method: 'GET',\r\n                        headers: { 'Authorization': `Bearer ${accessToken}` }\r\n                    });\r\n                    if (claudeRes.ok) {\r\n                        const claudeData = await claudeRes.json();\r\n                        if (claudeData.models) {\r\n                            for (const m of claudeData.models) {\r\n                                const id = (m.name || '').split('/').pop();\r\n                                if (!id || !id.startsWith('claude-')) continue;\r\n                                let name = m.displayName || id;\r\n                                const dateMatch = id.match(/(\\d{4})(\\d{2})(\\d{2})/);\r\n                                if (dateMatch && !name.includes('/')) name += ` (${dateMatch[1]}/${dateMatch[2]}/${dateMatch[3]})`;\r\n                                result.push({\r\n                                    uniqueId: `vertex-${id}`,\r\n                                    id: id,\r\n                                    name: name\r\n                                });\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (ce) {\r\n                    console.warn('[CPM-Vertex] Claude model listing not available:', ce.message);\r\n                }\r\n\r\n                return result.length > 0 ? result : null;\r\n            } catch (e) {\r\n                console.warn('[CPM-Vertex] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                keyJson: await CPM.safeGetArg('cpm_vertex_key_json'),\r\n                location: await CPM.safeGetArg('cpm_vertex_location'),\r\n                model: modelDef.id,\r\n                thinking: await CPM.safeGetArg('cpm_vertex_thinking_level'),\r\n                preserveSystem: await CPM.safeGetBoolArg('chat_vertex_preserveSystem'),\r\n                showThoughtsToken: await CPM.safeGetBoolArg('chat_vertex_showThoughtsToken'),\r\n                useThoughtSignature: await CPM.safeGetBoolArg('chat_vertex_useThoughtSignature'),\r\n            };\r\n\r\n            if (!config.keyJson) return { success: false, content: '[Vertex] No Service Account JSON key provided.' };\r\n            const project = JSON.parse(config.keyJson).project_id;\r\n            const loc = config.location || 'us-central1';\r\n            const model = config.model || 'gemini-2.5-flash';\r\n            const accessToken = await getVertexAccessToken(config.keyJson);\r\n            const baseUrl = loc === 'global' ? 'https://aiplatform.googleapis.com' : `https://${loc}-aiplatform.googleapis.com`;\r\n            const url = `${baseUrl}/v1beta1/projects/${project}/locations/${loc}/publishers/google/models/${model}:streamGenerateContent?alt=sse`;\r\n\r\n            const { contents, systemInstruction: sys } = CPM.formatToGemini(messages, config);\r\n            const body = { contents, generationConfig: { temperature: temp, maxOutputTokens: maxTokens } };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.generationConfig.topP = args.top_p;\r\n            if (args.top_k !== undefined && args.top_k !== null) body.generationConfig.topK = args.top_k;\r\n            if (args.frequency_penalty !== undefined && args.frequency_penalty !== null) body.generationConfig.frequencyPenalty = args.frequency_penalty;\r\n            if (args.presence_penalty !== undefined && args.presence_penalty !== null) body.generationConfig.presencePenalty = args.presence_penalty;\r\n            if (sys.length > 0) body.systemInstruction = { parts: sys.map(text => ({ text })) };\r\n            if (config.thinking && config.thinking !== 'off' && config.thinking !== 'none') {\r\n                body.generationConfig.thinkingConfig = { thinkingBudget: 8192 };\r\n            }\r\n\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${accessToken}` },\r\n                body: JSON.stringify(body)\r\n            });\r\n            if (!res.ok) {\r\n                if (res.status === 401 || res.status === 403) CPM.vertexTokenCache = { token: null, expiry: 0 };\r\n                return { success: false, content: await res.text() };\r\n            }\r\n            return { success: true, content: CPM.createSSEStream(res, (line) => CPM.parseGeminiSSELine(line, config), abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-vertex',\r\n            icon: 'ðŸ”·',\r\n            label: 'Vertex AI',\r\n            exportKeys: ['cpm_vertex_key_json', 'cpm_vertex_location', 'cpm_vertex_thinking_level', 'chat_vertex_preserveSystem', 'chat_vertex_showThoughtsToken', 'chat_vertex_useThoughtSignature', 'cpm_dynamic_vertexai'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-blue-400 mb-6 pb-3 border-b border-gray-700\">Vertex AI Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_vertex_key_json', 'Service Account JSON Key Code (ì„œë¹„ìŠ¤ ê³„ì • JSON í‚¤)', 'textarea')}\r\n                    ${await renderInput('cpm_vertex_location', 'Location Endpoint (ë¦¬ì „ ì—”ë“œí¬ì¸íŠ¸ ex: global, us-central1)')}\r\n                    ${await renderInput('cpm_dynamic_vertexai', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_vertex_thinking_level', 'Thinking Level (ìƒê° ìˆ˜ì¤€)', 'select', lists.thinkingList)}\r\n                    ${await renderInput('chat_vertex_preserveSystem', 'Preserve System (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë³´ì¡´)', 'checkbox')}\r\n                    ${await renderInput('chat_vertex_showThoughtsToken', 'Show Thoughts Token Info (ìƒê° í† í° ì•Œë¦¼ í‘œì‹œ)', 'checkbox')}\r\n                    ${await renderInput('chat_vertex_useThoughtSignature', 'Use Thought Signature (ìƒê° ì„œëª… ì¶”ì¶œ ì‚¬ìš©)', 'checkbox')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-gemini.js":"// @name CPM Provider - Gemini Studio\r\n// @version 1.3.0\r\n// @description Google Gemini Studio (API Key) provider for Cupcake PM (Streaming)\r\n// @icon ðŸ”µ\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-gemini.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-Gemini] CupcakePM API not found!'); return; }\r\n\r\n    const GEMINI_MODELS = [\r\n        { uniqueId: 'google-gemini-3-pro-preview', id: 'gemini-3-pro-preview', name: 'Gemini 3 Pro Preview' },\r\n        { uniqueId: 'google-gemini-3.1-pro-preview', id: 'gemini-3.1-pro-preview', name: 'Gemini 3.1 Pro Preview' },\r\n        { uniqueId: 'google-gemini-3-flash-preview', id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash Preview' },\r\n        { uniqueId: 'google-gemini-2.5-pro', id: 'gemini-2.5-pro', name: 'Gemini 2.5 Pro' },\r\n        { uniqueId: 'google-gemini-2.5-flash', id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash' },\r\n    ];\r\n\r\n    CPM.registerProvider({\r\n        name: 'GoogleAI',\r\n        models: GEMINI_MODELS,\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const key = await CPM.safeGetArg('cpm_gemini_key');\r\n                if (!key) return null;\r\n\r\n                let allModels = [];\r\n                let pageToken = null;\r\n\r\n                // Paginate through all available models\r\n                while (true) {\r\n                    let url = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}&pageSize=100`;\r\n                    if (pageToken) url += `&pageToken=${encodeURIComponent(pageToken)}`;\r\n\r\n                    const res = await CPM.smartFetch(url, { method: 'GET' });\r\n                    if (!res.ok) return null;\r\n\r\n                    const data = await res.json();\r\n                    if (data.models) allModels = allModels.concat(data.models);\r\n                    if (!data.nextPageToken) break;\r\n                    pageToken = data.nextPageToken;\r\n                }\r\n\r\n                return allModels\r\n                    .filter(m => {\r\n                        // Only include models that support generateContent (chat/generation)\r\n                        if (!m.supportedGenerationMethods?.includes('generateContent')) return false;\r\n                        // Only include gemini models\r\n                        const id = (m.name || '').replace('models/', '');\r\n                        return id.startsWith('gemini-');\r\n                    })\r\n                    .map(m => {\r\n                        const id = m.name.replace('models/', '');\r\n                        return {\r\n                            uniqueId: `google-${id}`,\r\n                            id: id,\r\n                            name: m.displayName || id\r\n                        };\r\n                    });\r\n            } catch (e) {\r\n                console.warn('[CPM-Gemini] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                key: await CPM.safeGetArg('cpm_gemini_key'),\r\n                model: modelDef.id,\r\n                thinking: await CPM.safeGetArg('cpm_gemini_thinking_level'),\r\n                preserveSystem: await CPM.safeGetBoolArg('chat_gemini_preserveSystem'),\r\n                showThoughtsToken: await CPM.safeGetBoolArg('chat_gemini_showThoughtsToken'),\r\n                useThoughtSignature: await CPM.safeGetBoolArg('chat_gemini_useThoughtSignature'),\r\n            };\r\n\r\n            const model = config.model || 'gemini-2.5-flash';\r\n            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${config.key}&alt=sse`;\r\n            const { contents, systemInstruction } = CPM.formatToGemini(messages, config);\r\n\r\n            const body = { contents, generationConfig: { temperature: temp, maxOutputTokens: maxTokens } };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.generationConfig.topP = args.top_p;\r\n            if (args.top_k !== undefined && args.top_k !== null) body.generationConfig.topK = args.top_k;\r\n            if (args.frequency_penalty !== undefined && args.frequency_penalty !== null) body.generationConfig.frequencyPenalty = args.frequency_penalty;\r\n            if (args.presence_penalty !== undefined && args.presence_penalty !== null) body.generationConfig.presencePenalty = args.presence_penalty;\r\n            if (systemInstruction.length > 0) body.systemInstruction = { parts: systemInstruction.map(text => ({ text })) };\r\n            if (config.thinking && config.thinking !== 'off') body.generationConfig.thinkingConfig = { thinkingBudget: 8192 };\r\n\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });\r\n            if (!res.ok) return { success: false, content: `[Gemini Error ${res.status}] ${await res.text()}` };\r\n            return { success: true, content: CPM.createSSEStream(res, (line) => CPM.parseGeminiSSELine(line, config), abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-gemini',\r\n            icon: 'ðŸ”µ',\r\n            label: 'Gemini Studio',\r\n            exportKeys: ['cpm_gemini_key', 'cpm_gemini_thinking_level', 'chat_gemini_preserveSystem', 'chat_gemini_showThoughtsToken', 'chat_gemini_useThoughtSignature', 'chat_gemini_usePlainFetch', 'cpm_dynamic_googleai'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-indigo-400 mb-6 pb-3 border-b border-gray-700\">Gemini Studio Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_gemini_key', 'API Key (API í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_dynamic_googleai', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_gemini_thinking_level', 'Thinking Level (ìƒê° ìˆ˜ì¤€)', 'select', lists.thinkingList)}\r\n                    ${await renderInput('chat_gemini_preserveSystem', 'Preserve System (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë³´ì¡´)', 'checkbox')}\r\n                    ${await renderInput('chat_gemini_showThoughtsToken', 'Show Thoughts Token Info (ìƒê° í† í° ì•Œë¦¼ í‘œì‹œ)', 'checkbox')}\r\n                    ${await renderInput('chat_gemini_useThoughtSignature', 'Use Thought Signature (ìƒê° ì„œëª… ì¶”ì¶œ ì‚¬ìš©)', 'checkbox')}\r\n                    ${await renderInput('chat_gemini_usePlainFetch', 'Use Plain Fetch (ì§ì ‘ ìš”ì²­ ì“°ê¸° - í”„ë¡ì‹œ/V3 ìºì‹± ìš°íšŒ)', 'checkbox')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-anthropic.js":"// @name CPM Provider - Anthropic\r\n// @version 1.5.0\r\n// @description Anthropic Claude provider for Cupcake PM (Streaming)\r\n// @icon ðŸŸ \r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-anthropic.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-Anthropic] CupcakePM API not found!'); return; }\r\n\r\n    const CLAUDE_MODELS_BASE = [\r\n        { baseId: \"claude-haiku-4-5\", date: \"20251001\", name: \"Claude 4.5 Haiku\", displayDate: \"2025/10/01\" },\r\n        { baseId: \"claude-sonnet-4\", date: \"20250514\", name: \"Claude 4 Sonnet\", displayDate: \"2025/05/14\" },\r\n        { baseId: \"claude-sonnet-4-5\", date: \"20250929\", name: \"Claude 4.5 Sonnet\", displayDate: \"2025/09/29\" },\r\n        { baseId: \"claude-opus-4\", date: \"20250514\", name: \"Claude 4 Opus\", displayDate: \"2025/05/14\" },\r\n        { baseId: \"claude-opus-4-1\", date: \"20250805\", name: \"Claude 4.1 Opus\", displayDate: \"2025/08/05\" },\r\n        { baseId: \"claude-opus-4-5\", date: \"20251101\", name: \"Claude 4.5 Opus\", displayDate: \"2025/11/01\" },\r\n    ];\r\n\r\n    // Claude 4.6 models have no date suffix and support adaptive thinking\r\n    const CLAUDE_46_MODELS = [\r\n        { uniqueId: 'anthropic-claude-sonnet-4-6', id: 'claude-sonnet-4-6', name: 'Claude 4.6 Sonnet' },\r\n        { uniqueId: 'anthropic-claude-opus-4-6', id: 'claude-opus-4-6', name: 'Claude 4.6 Opus' },\r\n    ];\r\n\r\n    const ADAPTIVE_THINKING_MODELS = ['claude-sonnet-4-6', 'claude-opus-4-6'];\r\n    const EFFORT_OPTIONS = ['low', 'medium', 'high', 'max'];\r\n\r\n    const models = [\r\n        ...CLAUDE_46_MODELS,\r\n        ...CLAUDE_MODELS_BASE.map(m => ({\r\n            uniqueId: `anthropic-${m.baseId}-${m.date}`,\r\n            id: `${m.baseId}-${m.date}`,\r\n            name: `${m.name} (${m.displayDate})`\r\n        }))\r\n    ];\r\n\r\n    CPM.registerProvider({\r\n        name: 'Anthropic',\r\n        models,\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const key = await CPM.safeGetArg('cpm_anthropic_key');\r\n                if (!key) return null;\r\n\r\n                let allModels = [];\r\n                let afterId = null;\r\n\r\n                // Paginate through all available models\r\n                while (true) {\r\n                    let url = 'https://api.anthropic.com/v1/models?limit=100';\r\n                    if (afterId) url += `&after_id=${encodeURIComponent(afterId)}`;\r\n\r\n                    const res = await CPM.smartFetch(url, {\r\n                        method: 'GET',\r\n                        headers: { 'x-api-key': key, 'anthropic-version': '2023-06-01' }\r\n                    });\r\n                    if (!res.ok) return null;\r\n\r\n                    const data = await res.json();\r\n                    if (data.data) allModels = allModels.concat(data.data);\r\n                    if (!data.has_more) break;\r\n                    afterId = data.last_id;\r\n                }\r\n\r\n                return allModels\r\n                    .filter(m => m.type === 'model')\r\n                    .map(m => {\r\n                        let name = m.display_name || m.id;\r\n                        // Append date suffix if present (e.g., \"20251001\" -> \"2025/10/01\")\r\n                        const dateMatch = m.id.match(/(\\d{4})(\\d{2})(\\d{2})$/);\r\n                        if (dateMatch) name += ` (${dateMatch[1]}/${dateMatch[2]}/${dateMatch[3]})`;\r\n                        return { uniqueId: `anthropic-${m.id}`, id: m.id, name };\r\n                    });\r\n            } catch (e) {\r\n                console.warn('[CPM-Anthropic] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                url: await CPM.safeGetArg('cpm_anthropic_url'),\r\n                key: await CPM.safeGetArg('cpm_anthropic_key'),\r\n                model: await CPM.safeGetArg('cpm_anthropic_model') || modelDef.id,\r\n                budget: await CPM.safeGetArg('cpm_anthropic_thinking_budget'),\r\n                effort: await CPM.safeGetArg('cpm_anthropic_thinking_effort'),\r\n                caching: await CPM.safeGetBoolArg('chat_claude_caching'),\r\n            };\r\n\r\n            const url = config.url || 'https://api.anthropic.com/v1/messages';\r\n            const { messages: formattedMsgs, system: systemPrompt } = CPM.formatToAnthropic(messages, config);\r\n\r\n            const body = {\r\n                model: config.model || 'claude-3-5-sonnet-20241022',\r\n                max_tokens: maxTokens,\r\n                temperature: temp,\r\n                messages: formattedMsgs,\r\n                stream: true,\r\n            };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.top_p = args.top_p;\r\n            if (args.top_k !== undefined && args.top_k !== null) body.top_k = args.top_k;\r\n            if (systemPrompt) {\r\n                if (config.caching) {\r\n                    body.system = [{ type: 'text', text: systemPrompt, cache_control: { type: 'ephemeral' } }];\r\n                } else {\r\n                    body.system = systemPrompt;\r\n                }\r\n            }\r\n\r\n            const isAdaptiveModel = ADAPTIVE_THINKING_MODELS.some(m => (config.model || '').startsWith(m));\r\n\r\n            if (isAdaptiveModel && (config.effort || config.budget > 0)) {\r\n                // Claude 4.6 models: use adaptive thinking (manual mode is deprecated)\r\n                body.thinking = { type: 'adaptive' };\r\n                const effort = config.effort && EFFORT_OPTIONS.includes(config.effort) ? config.effort : 'high';\r\n                body.output_config = { effort };\r\n                delete body.temperature;\r\n            } else if (config.budget && config.budget > 0) {\r\n                // Legacy models: use manual extended thinking with budget_tokens\r\n                body.thinking = { type: 'enabled', budget_tokens: parseInt(config.budget) };\r\n                if (body.max_tokens <= body.thinking.budget_tokens) body.max_tokens = body.thinking.budget_tokens + 4096;\r\n                delete body.temperature;\r\n            }\r\n\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json', 'x-api-key': config.key, 'anthropic-version': '2023-06-01' },\r\n                body: JSON.stringify(body)\r\n            });\r\n            if (!res.ok) return { success: false, content: `[Anthropic Error ${res.status}] ${await res.text()}` };\r\n            return { success: true, content: CPM.createAnthropicSSEStream(res, abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-anthropic',\r\n            icon: 'ðŸŸ ',\r\n            label: 'Anthropic',\r\n            exportKeys: ['cpm_anthropic_key', 'cpm_anthropic_thinking_budget', 'cpm_anthropic_thinking_effort', 'chat_claude_caching', 'cpm_anthropic_url', 'cpm_dynamic_anthropic'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-orange-400 mb-6 pb-3 border-b border-gray-700\">Anthropic Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_anthropic_key', 'API Key (API í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_dynamic_anthropic', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_anthropic_thinking_budget', 'Thinking Budget Tokens (ìƒê° í† í° ì˜ˆì‚° - 4.5 ì´í•˜ ëª¨ë¸ìš©, 0ì€ ë„ê¸°)', 'number')}\r\n                    ${await renderInput('cpm_anthropic_thinking_effort', 'Adaptive Thinking Effort (4.6 ëª¨ë¸ìš©: low/medium/high/max)')}\r\n                    ${await renderInput('chat_claude_caching', 'Cache Enabled (í”„ë¡¬í”„íŠ¸ ìºì‹± ì‚¬ìš©)', 'checkbox')}\r\n                    ${await renderInput('cpm_anthropic_url', 'Custom Base URL (ì»¤ìŠ¤í…€ API ì£¼ì†Œ - ì„ íƒì‚¬í•­)')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-openai.js":"// @name CPM Provider - OpenAI\r\n// @version 1.4.0\r\n// @description OpenAI provider for Cupcake PM (Streaming)\r\n// @icon ðŸŸ¢\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-openai.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-OpenAI] CupcakePM API not found!'); return; }\r\n\r\n    CPM.registerProvider({\r\n        name: 'OpenAI',\r\n        models: [\r\n            { uniqueId: 'openai-gpt-4.1-2025-04-14', id: 'gpt-4.1-2025-04-14', name: 'GPT-4.1 (2025/04/14)' },\r\n            { uniqueId: 'openai-chatgpt-4o-latest', id: 'chatgpt-4o-latest', name: 'ChatGPT-4o (Latest)' },\r\n            { uniqueId: 'openai-gpt-5-2025-08-07', id: 'gpt-5-2025-08-07', name: 'gpt-5 (2025/08/07)' },\r\n            { uniqueId: 'openai-gpt-5-mini-2025-08-07', id: 'gpt-5-mini-2025-08-07', name: 'gpt-5-mini (2025/08/07)' },\r\n            { uniqueId: 'openai-gpt-5-nano-2025-08-07', id: 'gpt-5-nano-2025-08-07', name: 'gpt-5-nano (2025/08/07)' },\r\n            { uniqueId: 'openai-gpt-5-chat-latest', id: 'gpt-5-chat-latest', name: 'gpt-5-chat (Latest)' },\r\n            { uniqueId: 'openai-gpt-5.1-2025-11-13', id: 'gpt-5.1-2025-11-13', name: 'GPT-5.1 (2025/11/13)' },\r\n            { uniqueId: 'openai-gpt-5.1-chat-latest', id: 'gpt-5.1-chat-latest', name: 'GPT-5.1 Chat (Latest)' },\r\n            { uniqueId: 'openai-gpt-5.2-2025-12-11', id: 'gpt-5.2-2025-12-11', name: 'GPT-5.2 (2025/12/11)' },\r\n            { uniqueId: 'openai-gpt-5.2-chat-latest', id: 'gpt-5.2-chat-latest', name: 'GPT-5.2 Chat (Latest)' },\r\n        ],\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const key = await CPM.safeGetArg('cpm_openai_key');\r\n                if (!key) return null;\r\n\r\n                const res = await CPM.smartFetch('https://api.openai.com/v1/models', {\r\n                    method: 'GET',\r\n                    headers: { 'Authorization': `Bearer ${key}` }\r\n                });\r\n                if (!res.ok) return null;\r\n\r\n                const data = await res.json();\r\n                if (!data.data) return null;\r\n\r\n                // Filter to chat-capable models only\r\n                const INCLUDE_PREFIXES = ['gpt-4', 'gpt-5', 'chatgpt-', 'o1', 'o3', 'o4'];\r\n                const EXCLUDE_KEYWORDS = ['audio', 'realtime', 'search', 'transcribe', 'instruct', 'embedding', 'tts', 'whisper', 'dall-e'];\r\n\r\n                const chatModels = data.data.filter(m => {\r\n                    const id = m.id;\r\n                    const included = INCLUDE_PREFIXES.some(pfx => id.startsWith(pfx));\r\n                    if (!included) return false;\r\n                    const excluded = EXCLUDE_KEYWORDS.some(kw => id.toLowerCase().includes(kw));\r\n                    return !excluded;\r\n                });\r\n\r\n                return chatModels.map(m => {\r\n                    let name = m.id;\r\n                    const dateMatch = m.id.match(/-(\\d{4})-(\\d{2})-(\\d{2})$/);\r\n                    if (dateMatch) {\r\n                        name = m.id.replace(/-\\d{4}-\\d{2}-\\d{2}$/, '') + ` (${dateMatch[1]}/${dateMatch[2]}/${dateMatch[3]})`;\r\n                    } else if (m.id.endsWith('-latest')) {\r\n                        name = m.id.replace(/-latest$/, '') + ' (Latest)';\r\n                    }\r\n                    name = name.replace(/^gpt-/i, 'GPT-').replace(/^chatgpt-/i, 'ChatGPT-');\r\n                    return { uniqueId: `openai-${m.id}`, id: m.id, name };\r\n                });\r\n            } catch (e) {\r\n                console.warn('[CPM-OpenAI] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                url: await CPM.safeGetArg('cpm_openai_url'),\r\n                key: await CPM.safeGetArg('cpm_openai_key'),\r\n                model: await CPM.safeGetArg('cpm_openai_model') || modelDef.id,\r\n                reasoning: await CPM.safeGetArg('cpm_openai_reasoning'),\r\n                verbosity: await CPM.safeGetArg('cpm_openai_verbosity'),\r\n                servicetier: await CPM.safeGetArg('common_openai_servicetier'),\r\n            };\r\n\r\n            // Helper: detect models that require max_completion_tokens instead of max_tokens\r\n            const needsMaxCompletionTokens = (model) => {\r\n                if (!model) return false;\r\n                const m = model.toLowerCase();\r\n                return /^(gpt-5|o[1-9])/.test(m);\r\n            };\r\n\r\n            // Helper: validate service_tier value\r\n            const validServiceTiers = new Set(['auto', 'flex', 'default']);\r\n\r\n            const url = config.url || 'https://api.openai.com/v1/chat/completions';\r\n            const modelName = config.model || 'gpt-4o';\r\n            const formattedMessages = CPM.formatToOpenAI(messages, config);\r\n\r\n            const body = {\r\n                model: modelName,\r\n                messages: Array.isArray(formattedMessages) ? formattedMessages.filter(m => m != null && typeof m === 'object') : [],\r\n                temperature: temp,\r\n                stream: true,\r\n            };\r\n\r\n            // max_tokens vs max_completion_tokens: newer models require max_completion_tokens\r\n            if (needsMaxCompletionTokens(modelName)) {\r\n                body.max_completion_tokens = maxTokens;\r\n            } else {\r\n                body.max_tokens = maxTokens;\r\n            }\r\n\r\n            if (args.top_p !== undefined && args.top_p !== null) body.top_p = args.top_p;\r\n            if (args.frequency_penalty !== undefined && args.frequency_penalty !== null) body.frequency_penalty = args.frequency_penalty;\r\n            if (args.presence_penalty !== undefined && args.presence_penalty !== null) body.presence_penalty = args.presence_penalty;\r\n\r\n            // service_tier: only send known valid lowercase values, skip empty/'auto' (default)\r\n            if (config.servicetier) {\r\n                const tier = config.servicetier.trim().toLowerCase();\r\n                if (tier && tier !== 'auto' && validServiceTiers.has(tier)) {\r\n                    body.service_tier = tier;\r\n                }\r\n            }\r\n\r\n            if (config.maxout) {\r\n                body.max_output_tokens = maxTokens;\r\n                delete body.max_tokens;\r\n                delete body.max_completion_tokens;\r\n            }\r\n            if (config.reasoning && config.reasoning !== 'none') { body.reasoning_effort = config.reasoning; delete body.temperature; }\r\n            if (config.verbosity && config.verbosity !== 'none') body.verbosity = config.verbosity;\r\n\r\n            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.key}` };\r\n            // Copilot auto-detection: use ensureCopilotApiToken from provider-manager\r\n            // Per LBI reference: chat completions only needs Copilot-Integration-Id + X-Request-Id\r\n            if (url.includes('githubcopilot.com')) {\r\n                let copilotApiToken = '';\r\n                if (typeof window.CupcakePM?.ensureCopilotApiToken === 'function') {\r\n                    copilotApiToken = await window.CupcakePM.ensureCopilotApiToken();\r\n                } else if (window._cpmCopilotApiToken) {\r\n                    copilotApiToken = window._cpmCopilotApiToken;\r\n                }\r\n                if (copilotApiToken) {\r\n                    headers['Authorization'] = `Bearer ${copilotApiToken}`;\r\n                }\r\n                headers['Copilot-Integration-Id'] = 'vscode-chat';\r\n                headers['X-Request-Id'] = crypto.randomUUID ? crypto.randomUUID() : Date.now().toString();\r\n            }\r\n\r\n            // Final safety: sanitize JSON body to remove any null message entries\r\n            const bodyJSON = JSON.stringify(body);\r\n            let safeBody = bodyJSON;\r\n            try {\r\n                const parsed = JSON.parse(bodyJSON);\r\n                if (Array.isArray(parsed.messages)) {\r\n                    parsed.messages = parsed.messages.filter(m => m != null && typeof m === 'object' && m.content !== null && m.content !== undefined);\r\n                }\r\n                safeBody = JSON.stringify(parsed);\r\n            } catch (_) { /* use original */ }\r\n\r\n            // Use smartNativeFetch: direct fetch() first (bypasses proxy region-blocking),\r\n            // falls back to nativeFetch (proxy) if direct fails.\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, { method: 'POST', headers, body: safeBody });\r\n            if (!res.ok) return { success: false, content: `[OpenAI Error ${res.status}] ${await res.text()}` };\r\n            return { success: true, content: CPM.createSSEStream(res, CPM.parseOpenAISSELine, abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-openai',\r\n            icon: 'ðŸŸ¢',\r\n            label: 'OpenAI',\r\n            exportKeys: ['cpm_openai_key', 'cpm_openai_reasoning', 'cpm_openai_verbosity', 'common_openai_servicetier', 'cpm_openai_url', 'cpm_dynamic_openai'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-green-400 mb-6 pb-3 border-b border-gray-700\">OpenAI Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_openai_key', 'API Key (sk-...)', 'password')}\r\n                    ${await renderInput('cpm_dynamic_openai', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_openai_reasoning', 'Reasoning Effort (ì¶”ë¡  ìˆ˜ì¤€ - o3, o1 series)', 'select', lists.reasoningList)}\r\n                    ${await renderInput('cpm_openai_verbosity', 'Response Verbosity (ì‘ë‹µ ìƒì„¸)', 'select', lists.verbosityList)}\r\n                    ${await renderInput('common_openai_servicetier', 'Service Tier (ì‘ë‹µ ì†ë„)', 'select', [{ value: '', text: 'Auto (ìžë™)' }, { value: 'flex', text: 'Flex' }, { value: 'default', text: 'Default' }])}\r\n                    ${await renderInput('cpm_openai_url', 'Custom Base URL (ì»¤ìŠ¤í…€ API ì£¼ì†Œ - ì„ íƒì‚¬í•­)')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-deepseek.js":"// @name CPM Provider - DeepSeek\r\n// @version 1.3.0\r\n// @description DeepSeek provider for Cupcake PM (Streaming)\r\n// @icon ðŸŸ£\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-deepseek.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-DeepSeek] CupcakePM API not found!'); return; }\r\n\r\n    CPM.registerProvider({\r\n        name: 'DeepSeek',\r\n        models: [\r\n            { uniqueId: 'deepseek-chat', id: 'deepseek-chat', name: 'Deepseek Chat' },\r\n            { uniqueId: 'deepseek-reasoner', id: 'deepseek-reasoner', name: 'Deepseek Reasoner' },\r\n        ],\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const key = await CPM.safeGetArg('cpm_deepseek_key');\r\n                if (!key) return null;\r\n\r\n                const res = await CPM.smartFetch('https://api.deepseek.com/models', {\r\n                    method: 'GET',\r\n                    headers: { 'Authorization': `Bearer ${key}` }\r\n                });\r\n                if (!res.ok) return null;\r\n\r\n                const data = await res.json();\r\n                if (!data.data) return null;\r\n\r\n                return data.data.map(m => {\r\n                    // Format name: \"deepseek-chat\" -> \"DeepSeek Chat\"\r\n                    let name = m.id.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\r\n                    name = name.replace(/^Deepseek/i, 'DeepSeek');\r\n                    return { uniqueId: `deepseek-${m.id}`, id: m.id, name };\r\n                });\r\n            } catch (e) {\r\n                console.warn('[CPM-DeepSeek] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                url: await CPM.safeGetArg('cpm_deepseek_url'),\r\n                key: await CPM.safeGetArg('cpm_deepseek_key'),\r\n                model: modelDef.id,\r\n            };\r\n\r\n            const url = config.url || 'https://api.deepseek.com/v1/chat/completions';\r\n            const body = { model: config.model || 'deepseek-chat', messages: CPM.formatToOpenAI(messages), temperature: temp, max_tokens: maxTokens, stream: true };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.top_p = args.top_p;\r\n            if (args.frequency_penalty !== undefined && args.frequency_penalty !== null) body.frequency_penalty = args.frequency_penalty;\r\n            if (args.presence_penalty !== undefined && args.presence_penalty !== null) body.presence_penalty = args.presence_penalty;\r\n\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.key}` },\r\n                body: JSON.stringify(body)\r\n            });\r\n            if (!res.ok) return { success: false, content: await res.text() };\r\n            return { success: true, content: CPM.createSSEStream(res, CPM.parseOpenAISSELine, abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-deepseek',\r\n            icon: 'ðŸŸ£',\r\n            label: 'DeepSeek',\r\n            exportKeys: ['cpm_deepseek_key', 'cpm_deepseek_url', 'cpm_dynamic_deepseek'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-purple-400 mb-6 pb-3 border-b border-gray-700\">DeepSeek Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_deepseek_key', 'API Key (API í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_dynamic_deepseek', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_deepseek_url', 'Custom Base URL (ì»¤ìŠ¤í…€ API ì£¼ì†Œ - ì„ íƒì‚¬í•­)')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-openrouter.js":"// @name CPM Provider - OpenRouter\r\n// @version 1.2.0\r\n// @description OpenRouter provider for Cupcake PM (Streaming)\r\n// @icon ðŸŒ\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-openrouter.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-OpenRouter] CupcakePM API not found!'); return; }\r\n\r\n    CPM.registerProvider({\r\n        name: 'OpenRouter',\r\n        models: [\r\n            { uniqueId: 'openrouter-dynamic', id: 'openrouter', name: 'OpenRouter (Set inside PM config)' },\r\n        ],\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                url: await CPM.safeGetArg('cpm_openrouter_url'),\r\n                key: await CPM.safeGetArg('cpm_openrouter_key'),\r\n                model: await CPM.safeGetArg('cpm_openrouter_model'),\r\n                reasoning: await CPM.safeGetArg('cpm_openrouter_reasoning'),\r\n                providerString: await CPM.safeGetArg('cpm_openrouter_provider'),\r\n            };\r\n\r\n            const url = config.url || 'https://openrouter.ai/api/v1/chat/completions';\r\n            const body = { model: config.model, messages: CPM.formatToOpenAI(messages), temperature: temp, max_tokens: maxTokens, stream: true };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.top_p = args.top_p;\r\n            if (args.top_k !== undefined && args.top_k !== null) body.top_k = args.top_k;\r\n            if (args.frequency_penalty !== undefined && args.frequency_penalty !== null) body.frequency_penalty = args.frequency_penalty;\r\n            if (args.presence_penalty !== undefined && args.presence_penalty !== null) body.presence_penalty = args.presence_penalty;\r\n            if (args.repetition_penalty !== undefined && args.repetition_penalty !== null) body.repetition_penalty = args.repetition_penalty;\r\n            if (config.reasoning && config.reasoning !== 'none') {\r\n                body.reasoning = { effort: config.reasoning, max_tokens: 8192 };\r\n            }\r\n            if (config.providerString) {\r\n                body.provider = { id: config.providerString };\r\n            }\r\n\r\n            const fetchFn = typeof CPM.smartNativeFetch === 'function' ? CPM.smartNativeFetch : Risuai.nativeFetch;\r\n            const res = await fetchFn(url, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Authorization': `Bearer ${config.key}`,\r\n                    'HTTP-Referer': 'https://risuai.xyz',\r\n                    'X-Title': 'RisuAI - CPM'\r\n                },\r\n                body: JSON.stringify(body)\r\n            });\r\n            if (!res.ok) return { success: false, content: await res.text() };\r\n            return { success: true, content: CPM.createSSEStream(res, CPM.parseOpenAISSELine, abortSignal) };\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-openrouter',\r\n            icon: 'ðŸŒ',\r\n            label: 'OpenRouter',\r\n            exportKeys: ['cpm_openrouter_key', 'cpm_openrouter_provider', 'cpm_openrouter_reasoning', 'cpm_openrouter_url'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-teal-400 mb-6 pb-3 border-b border-gray-700\">OpenRouter Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_openrouter_key', 'API Key (API í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_openrouter_provider', 'Provider String (í”„ë¡œë°”ì´ë” ë¬¸ìžì—´ e.g., Hyperbolic)', 'text')}\r\n                    ${await renderInput('cpm_openrouter_reasoning', 'Reasoning Header (ì¶”ë¡  í—¤ë”)', 'select', lists.reasoningList)}\r\n                    ${await renderInput('cpm_openrouter_url', 'Custom Base URL (ì»¤ìŠ¤í…€ API ì£¼ì†Œ - ì„ íƒì‚¬í•­)')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-provider-aws.js":"// @name CPM Provider - AWS Bedrock\r\n// @version 1.4.0\r\n// @description AWS Bedrock (Claude) provider for Cupcake PM (Streaming)\r\n// @icon ðŸ”¶\r\n// @update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-provider-aws.js\r\n\r\n(() => {\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM-AWS] CupcakePM API not found!'); return; }\r\n\r\n    const AWS_MODELS = [\r\n        { uniqueId: 'aws-us.anthropic.claude-opus-4-6-v1', id: 'us.anthropic.claude-opus-4-6-v1', name: 'Claude 4.6 Opus' },\r\n        { uniqueId: 'aws-us.anthropic.claude-sonnet-4-6', id: 'us.anthropic.claude-sonnet-4-6', name: 'Claude 4.6 Sonnet' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-5-opus-20251101-v1:0', id: 'us.anthropic.claude-4-5-opus-20251101-v1:0', name: 'Claude 4.5 Opus (20251101)' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-5-sonnet-20250929-v1:0', id: 'us.anthropic.claude-4-5-sonnet-20250929-v1:0', name: 'Claude 4.5 Sonnet (20250929)' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-5-haiku-20251001-v1:0', id: 'us.anthropic.claude-4-5-haiku-20251001-v1:0', name: 'Claude 4.5 Haiku (20251001)' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-1-opus-20250805-v1:0', id: 'us.anthropic.claude-4-1-opus-20250805-v1:0', name: 'Claude 4.1 Opus (20250805)' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-opus-20250514-v1:0', id: 'us.anthropic.claude-4-opus-20250514-v1:0', name: 'Claude 4 Opus (20250514)' },\r\n        { uniqueId: 'aws-us.anthropic.claude-4-sonnet-20250514-v1:0', id: 'us.anthropic.claude-4-sonnet-20250514-v1:0', name: 'Claude 4 Sonnet (20250514)' },\r\n    ];\r\n\r\n    const ADAPTIVE_THINKING_MODEL_PATTERNS = ['claude-opus-4-6', 'claude-sonnet-4-6'];\r\n    const EFFORT_OPTIONS = ['low', 'medium', 'high', 'max'];\r\n\r\n    CPM.registerProvider({\r\n        name: 'AWS',\r\n        models: AWS_MODELS,\r\n        fetchDynamicModels: async () => {\r\n            try {\r\n                const key = await CPM.safeGetArg('cpm_aws_key');\r\n                const secret = await CPM.safeGetArg('cpm_aws_secret');\r\n                const region = await CPM.safeGetArg('cpm_aws_region');\r\n                if (!key || !secret || !region) return null;\r\n\r\n                const AwsV4Signer = CPM.AwsV4Signer;\r\n                const url = `https://bedrock.${region}.amazonaws.com/foundation-models`;\r\n                const signer = new AwsV4Signer({\r\n                    method: 'GET',\r\n                    url: url,\r\n                    accessKeyId: key,\r\n                    secretAccessKey: secret,\r\n                    service: 'bedrock',\r\n                    region: region,\r\n                });\r\n                const signed = await signer.sign();\r\n                const res = await Risuai.nativeFetch(signed.url.toString(), {\r\n                    method: signed.method,\r\n                    headers: signed.headers,\r\n                });\r\n                if (!res.ok) return null;\r\n\r\n                const data = await res.json();\r\n                if (!data.modelSummaries) return null;\r\n\r\n                // Filter to text-generation capable models (Claude, Llama, Mistral, etc.)\r\n                const results = [];\r\n                for (const m of data.modelSummaries) {\r\n                    const id = m.modelId;\r\n                    if (!id) continue;\r\n                    // Only include models that support text output\r\n                    const outputModes = m.outputModalities || [];\r\n                    if (!outputModes.includes('TEXT')) continue;\r\n                    // Only include invoke-capable models\r\n                    const inferenceModes = m.inferenceTypesSupported || [];\r\n                    if (!inferenceModes.includes('ON_DEMAND') && !inferenceModes.includes('INFERENCE_PROFILE')) continue;\r\n\r\n                    let name = m.modelName || id;\r\n                    // Add provider prefix for clarity\r\n                    const provider = m.providerName || '';\r\n                    if (provider && !name.toLowerCase().startsWith(provider.toLowerCase())) {\r\n                        name = `${provider} ${name}`;\r\n                    }\r\n\r\n                    results.push({ uniqueId: `aws-${id}`, id: id, name: name });\r\n                }\r\n\r\n                // Also try cross-region inference profiles\r\n                try {\r\n                    const profileUrl = `https://bedrock.${region}.amazonaws.com/inference-profiles`;\r\n                    const profileSigner = new AwsV4Signer({\r\n                        method: 'GET',\r\n                        url: profileUrl,\r\n                        accessKeyId: key,\r\n                        secretAccessKey: secret,\r\n                        service: 'bedrock',\r\n                        region: region,\r\n                    });\r\n                    const profileSigned = await profileSigner.sign();\r\n                    const profileRes = await Risuai.nativeFetch(profileSigned.url.toString(), {\r\n                        method: profileSigned.method,\r\n                        headers: profileSigned.headers,\r\n                    });\r\n                    if (profileRes.ok) {\r\n                        const profileData = await profileRes.json();\r\n                        const profiles = profileData.inferenceProfileSummaries || [];\r\n                        for (const p of profiles) {\r\n                            const profileId = p.inferenceProfileId || p.inferenceProfileArn;\r\n                            if (!profileId) continue;\r\n                            // Skip if already have this model\r\n                            if (results.some(r => r.id === profileId)) continue;\r\n                            const name = p.inferenceProfileName || profileId;\r\n                            // Only include Anthropic cross-region profiles for now\r\n                            if (profileId.includes('anthropic') || profileId.includes('claude')) {\r\n                                results.push({ uniqueId: `aws-${profileId}`, id: profileId, name: `${name} (Cross-Region)` });\r\n                            }\r\n                        }\r\n                    }\r\n                } catch (pe) {\r\n                    console.warn('[CPM-AWS] Inference profiles listing not available:', pe.message);\r\n                }\r\n\r\n                return results.length > 0 ? results : null;\r\n            } catch (e) {\r\n                console.warn('[CPM-AWS] Dynamic model fetch error:', e);\r\n                return null;\r\n            }\r\n        },\r\n        fetcher: async function (modelDef, messages, temp, maxTokens, args, abortSignal) {\r\n            const config = {\r\n                key: await CPM.safeGetArg('cpm_aws_key'),\r\n                secret: await CPM.safeGetArg('cpm_aws_secret'),\r\n                region: await CPM.safeGetArg('cpm_aws_region'),\r\n                model: modelDef.id,\r\n                budget: await CPM.safeGetArg('cpm_aws_thinking_budget'),\r\n                effort: await CPM.safeGetArg('cpm_aws_thinking_effort'),\r\n            };\r\n\r\n            if (!config.key || !config.secret || !config.region || !config.model) {\r\n                return { success: false, content: \"[AWS Bedrock] Access Key, Secret, Region, and Model are required.\" };\r\n            }\r\n\r\n            // Fixed: formatToAnthropic returns { messages, system }, not { anthropicMessages, systemPrompt }\r\n            const { messages: anthropicMessages, system: systemPrompt } = CPM.formatToAnthropic(messages);\r\n            const body = {\r\n                messages: anthropicMessages,\r\n                max_tokens: maxTokens || 4096,\r\n                temperature: temp !== undefined ? temp : 0.7,\r\n                anthropic_version: \"bedrock-2023-05-31\"\r\n            };\r\n            if (args.top_p !== undefined && args.top_p !== null) body.top_p = args.top_p;\r\n            if (args.top_k !== undefined && args.top_k !== null) body.top_k = args.top_k;\r\n            if (systemPrompt) body.system = systemPrompt;\r\n\r\n            // Thinking support\r\n            const isAdaptiveModel = ADAPTIVE_THINKING_MODEL_PATTERNS.some(p => config.model.includes(p));\r\n            if (isAdaptiveModel && (config.effort || config.budget > 0)) {\r\n                // Claude 4.6 models: use adaptive thinking\r\n                body.thinking = { type: 'adaptive' };\r\n                const effort = config.effort && EFFORT_OPTIONS.includes(config.effort) ? config.effort : 'high';\r\n                body.output_config = { effort };\r\n                delete body.temperature;\r\n            } else if (config.budget && config.budget > 0) {\r\n                // Legacy models: use manual extended thinking\r\n                body.thinking = { type: 'enabled', budget_tokens: parseInt(config.budget) };\r\n                if (body.max_tokens <= body.thinking.budget_tokens) body.max_tokens = body.thinking.budget_tokens + 4096;\r\n                delete body.temperature;\r\n            }\r\n\r\n            try {\r\n                const AwsV4Signer = CPM.AwsV4Signer;\r\n                const streamUrl = `https://bedrock-runtime.${config.region}.amazonaws.com/model/${config.model}/invoke-with-response-stream`;\r\n                const signer = new AwsV4Signer({\r\n                    method: 'POST',\r\n                    url: streamUrl,\r\n                    accessKeyId: config.key,\r\n                    secretAccessKey: config.secret,\r\n                    service: 'bedrock',\r\n                    region: config.region,\r\n                    body: JSON.stringify(body),\r\n                    headers: { 'Content-Type': 'application/json', 'accept': 'application/vnd.amazon.eventstream' }\r\n                });\r\n\r\n                const signed = await signer.sign();\r\n                const res = await Risuai.nativeFetch(signed.url.toString(), {\r\n                    method: signed.method,\r\n                    headers: signed.headers,\r\n                    body: signed.body\r\n                });\r\n\r\n                if (!res.ok) return { success: false, content: `[AWS Bedrock Error ${res.status}] ${await res.text()}` };\r\n\r\n                // AWS Bedrock invoke-with-response-stream returns event stream format.\r\n                // Parse it to extract content_block_delta text chunks.\r\n                const reader = res.body.getReader();\r\n                const decoder = new TextDecoder();\r\n                let buffer = '';\r\n\r\n                const stream = new ReadableStream({\r\n                    async pull(controller) {\r\n                        try {\r\n                            while (true) {\r\n                                if (abortSignal && abortSignal.aborted) {\r\n                                    reader.cancel();\r\n                                    controller.close();\r\n                                    return;\r\n                                }\r\n                                const { done, value } = await reader.read();\r\n                                if (done) { controller.close(); return; }\r\n                                buffer += decoder.decode(value, { stream: true });\r\n                                // AWS eventstream wraps JSON payloads; extract them\r\n                                // The response contains base64-encoded JSON events or raw JSON chunks\r\n                                const lines = buffer.split('\\n');\r\n                                buffer = lines.pop() || '';\r\n                                for (const line of lines) {\r\n                                    const trimmed = line.trim();\r\n                                    if (!trimmed) continue;\r\n                                    try {\r\n                                        // Try to parse as JSON directly (Bedrock may send raw JSON events)\r\n                                        const obj = JSON.parse(trimmed);\r\n                                        if (obj.bytes) {\r\n                                            // Base64 encoded event payload\r\n                                            const decoded = JSON.parse(atob(obj.bytes));\r\n                                            if (decoded.type === 'content_block_delta' && decoded.delta?.text) {\r\n                                                controller.enqueue(decoded.delta.text);\r\n                                            }\r\n                                        } else if (obj.type === 'content_block_delta' && obj.delta?.text) {\r\n                                            controller.enqueue(obj.delta.text);\r\n                                        }\r\n                                    } catch {\r\n                                        // Try extracting JSON from binary event stream format\r\n                                        // Look for content_block_delta patterns\r\n                                        const deltaMatch = trimmed.match(/\"type\"\\s*:\\s*\"content_block_delta\"[^}]*\"delta\"\\s*:\\s*\\{[^}]*\"text\"\\s*:\\s*\"((?:[^\"\\\\]|\\\\.)*)\"/);\r\n                                        if (deltaMatch) {\r\n                                            try {\r\n                                                controller.enqueue(JSON.parse('\"' + deltaMatch[1] + '\"'));\r\n                                            } catch { }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        } catch (e) {\r\n                            if (e.name !== 'AbortError') controller.error(e);\r\n                            else controller.close();\r\n                        }\r\n                    },\r\n                    cancel() { reader.cancel(); }\r\n                });\r\n\r\n                return { success: true, content: stream };\r\n            } catch (e) {\r\n                return { success: false, content: `[AWS Bedrock Exception] ${e.message}` };\r\n            }\r\n        },\r\n        settingsTab: {\r\n            id: 'tab-aws',\r\n            icon: 'ðŸ”¶',\r\n            label: 'AWS Bedrock',\r\n            exportKeys: ['cpm_aws_key', 'cpm_aws_secret', 'cpm_aws_region', 'cpm_aws_thinking_budget', 'cpm_aws_thinking_effort', 'cpm_dynamic_aws'],\r\n            renderContent: async (renderInput, lists) => {\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-amber-400 mb-6 pb-3 border-b border-gray-700\">AWS Bedrock Configuration (ì„¤ì •)</h3>\r\n                    ${await renderInput('cpm_aws_key', 'Access Key ID (ì•¡ì„¸ìŠ¤ í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_aws_secret', 'Secret Access Key (ì‹œí¬ë¦¿ í‚¤)', 'password')}\r\n                    ${await renderInput('cpm_aws_region', 'Region (ë¦¬ì „ ex: us-east-1)')}\r\n                    ${await renderInput('cpm_dynamic_aws', 'ðŸ“¡ ì„œë²„ì—ì„œ ëª¨ë¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Fetch models from API)', 'checkbox')}\r\n                    ${await renderInput('cpm_aws_thinking_budget', 'Thinking Budget Tokens (4.5 ì´í•˜ ëª¨ë¸ìš©, 0ì€ ë„ê¸°)', 'number')}\r\n                    ${await renderInput('cpm_aws_thinking_effort', 'Adaptive Thinking Effort (4.6 ëª¨ë¸ìš©: low/medium/high/max)')}\r\n                `;\r\n            }\r\n        }\r\n    });\r\n})();\r\n","cpm-chat-resizer.js":"//@name CPM Component - Chat Input Resizer\r\n//@display-name Cupcake UI Resizer\r\n//@api 3.0\r\n//@version 0.1.4\r\n//@author Cupcake\r\n//@update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-chat-resizer.js\r\n\r\n/**\r\n * ======== CUPCAKE PM Sub-Plugin: Chat Input Resizer ========\r\n * \r\n * Provides a UI overlay button to expand the chat textareas to fullscreen\r\n * in RisuAI, resolving mobile input truncation. Hooks into Cupcake PM\r\n * for its settings tab, but can run entirely standalone.\r\n */\r\n/**\r\n * ======== CUPCAKE PM Sub-Plugin: Chat Input Resizer ========\r\n * \r\n * Provides a UI overlay button to expand the chat textareas to fullscreen\r\n * in RisuAI, resolving mobile input truncation. Hooks into Cupcake PM\r\n * for its settings tab, but can run entirely standalone.\r\n */\r\n(async () => {\r\n    // Note: We intentionally don't block the entire script execution here,\r\n    // because RisuAI V3 hot-reloading needs to re-evaluate the event listeners.\r\n\r\n    if (!window.Risuai && !window.risuai) {\r\n        console.warn('[CPM Resizer] RisuAI API variable missing. Halting plugin.');\r\n        return;\r\n    }\r\n    const risuai = window.risuai || window.Risuai;\r\n\r\n    try {\r\n        // ==========================================\r\n        // 1. SETTINGS UI INJECTION (HOOK TO HOST)\r\n        // ==========================================\r\n        window.CupcakePM_SubPlugins = window.CupcakePM_SubPlugins || [];\r\n        window.CupcakePM_SubPlugins = window.CupcakePM_SubPlugins.filter(p => p.id !== 'cpm-resizer');\r\n        window.CupcakePM_SubPlugins.push({\r\n            id: 'cpm-resizer',\r\n            name: 'Chat Input Resizer',\r\n            description: 'í…ìŠ¤íŠ¸ ìž…ë ¥ì°½ ëª¨ì„œë¦¬ì— í¬ê¸° ì¡°ì ˆ/ìµœëŒ€í™” ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.',\r\n            version: '0.1',\r\n            icon: 'â†•ï¸',\r\n            uiHtml: `\r\n                <div class=\"mb-2\">\r\n                    <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-300\">\r\n                        <input id=\"cpm_enable_chat_resizer\" type=\"checkbox\" class=\"form-checkbox text-blue-500 rounded bg-gray-800 border-gray-600 focus:ring-blue-500\">\r\n                        <span>Enable Chat Input Resizer (ìž…ë ¥ì°½ â†•ï¸ íŒì—… í¬ê¸° ì¡°ì ˆê¸° í™œì„±í™”)</span>\r\n                    </label>\r\n                </div>\r\n            `,\r\n            onRender: async (container, getArg, setVal) => {\r\n                const checkbox = container.querySelector('#cpm_enable_chat_resizer');\r\n                if (checkbox) {\r\n                    const isEnabled = await getArg('cpm_enable_chat_resizer');\r\n                    checkbox.checked = (isEnabled === 'false' || isEnabled === false) ? false : true;\r\n\r\n                    checkbox.addEventListener('change', (ev) => {\r\n                        setVal('cpm_enable_chat_resizer', ev.target.checked);\r\n                        isResizerEnabled = ev.target.checked;\r\n                    });\r\n                }\r\n            }\r\n        });\r\n\r\n        const handleSettingsRender = async (e) => {\r\n            const { safeGetArg, registerPlugin } = e.detail;\r\n\r\n            // Only inject if the host DOES NOT support the new plugin registry system\r\n            if (typeof registerPlugin !== 'function') {\r\n                // Fallback for older Cupcake PM versions\r\n                const { sidebar, content } = e.detail;\r\n                const tabBtnSrc = `\r\n                    <button class=\"w-full text-left px-5 py-2 text-sm hover:bg-gray-800 transition-colors focus:outline-none tab-btn text-blue-300 font-bold bg-blue-900/10\" data-target=\"tab-cpm-resizer\">\r\n                        â†•ï¸ UI Resizer\r\n                    </button>\r\n                `;\r\n                const targetHeader = Array.from(sidebar.querySelectorAll('div')).find(div => div.textContent.includes('Native Providers'));\r\n                if (targetHeader) {\r\n                    targetHeader.insertAdjacentHTML('beforebegin', tabBtnSrc);\r\n                } else {\r\n                    sidebar.querySelector('#cpm-tab-list')?.insertAdjacentHTML('beforeend', tabBtnSrc);\r\n                }\r\n\r\n                // For fallback, we still need safeGetArg, but it's passed from the event\r\n                const isEnabled = await safeGetArg('cpm_enable_chat_resizer');\r\n                const isChecked = (isEnabled === 'false' || isEnabled === false) ? '' : 'checked';\r\n                const panelSrc = `\r\n                    <div id=\"tab-cpm-resizer\" class=\"cpm-tab-content hidden\">\r\n                        <h3 class=\"text-3xl font-bold mb-6 pb-3 border-b border-gray-700\">Chat Input Resizer</h3>\r\n                        <p class=\"text-blue-300 font-semibold mb-6 border-l-4 border-blue-500 pl-4 py-1\">\r\n                            í…ìŠ¤íŠ¸ ìž…ë ¥ì°½ ëª¨ì„œë¦¬ì— í¬ê¸° ì¡°ì ˆ/ìµœëŒ€í™” ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.\r\n                        </p>\r\n                        <div class=\"mb-4\">\r\n                            <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-300\">\r\n                                <input id=\"cpm_enable_chat_resizer\" type=\"checkbox\" ${isChecked} class=\"form-checkbox text-blue-500 rounded bg-gray-800 border-gray-600 focus:ring-blue-500\">\r\n                                <span>Enable Chat Input Resizer (ìž…ë ¥ì°½ â†•ï¸ íŒì—… í¬ê¸° ì¡°ì ˆê¸° í™œì„±í™”)</span>\r\n                            </label>\r\n                        </div>\r\n                    </div>\r\n                `;\r\n                content.insertAdjacentHTML('beforeend', panelSrc);\r\n            }\r\n        };\r\n\r\n        // Clean up previous listener to prevent duplicates on hot-reload\r\n        if (window.__cpmResizerListener) {\r\n            document.removeEventListener('cupcakepm:render_settings', window.__cpmResizerListener);\r\n        }\r\n        window.__cpmResizerListener = handleSettingsRender;\r\n        document.addEventListener('cupcakepm:render_settings', handleSettingsRender);\r\n\r\n        const rootDoc = await risuai.getRootDocument();\r\n\r\n        // Safe helper to get arguments silently\r\n        const safeGetArg = async (key, defaultValue = '') => {\r\n            try {\r\n                const val = await risuai.getArgument(key);\r\n                return val !== undefined && val !== null && val !== '' ? val : defaultValue;\r\n            } catch {\r\n                return defaultValue;\r\n            }\r\n        };\r\n\r\n\r\n        // ==========================================\r\n        // 2. CSS ATTRIBUTE INJECTION\r\n        // ==========================================\r\n        const styleId = 'cpm-maximizer-styles';\r\n        if (!(await rootDoc.getElementById(styleId))) {\r\n            const styleEl = await rootDoc.createElement('style');\r\n            await styleEl.setAttribute('x-id', styleId);\r\n            // We use [x-cpm-maximized] to trigger the massive detached overlay\r\n            await styleEl.setInnerHTML(`\r\n                textarea[x-cpm-maximized=\"true\"] {\r\n                    position: fixed !important;\r\n                    top: 10vh !important;\r\n                    left: 10vw !important;\r\n                    width: 80vw !important;\r\n                    height: 80vh !important;\r\n                    max-height: none !important;\r\n                    z-index: 999999 !important;\r\n                    background-color: var(--bgcolor, #1e1e2e) !important;\r\n                    padding: 24px !important;\r\n                    box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 0 9999px rgba(0, 0, 0, 0.6) !important;\r\n                    border-radius: 12px !important;\r\n                    border: 2px solid var(--borderc, #555) !important;\r\n                    font-size: 1.1em !important;\r\n                    resize: none !important;\r\n                    transition: all 0.2s ease-out !important;\r\n                }\r\n                /* The button itself needs to float on top of the fullscreen textarea */\r\n                button[x-cpm-maximized-btn=\"true\"] {\r\n                    position: fixed !important;\r\n                    bottom: 12vh !important;\r\n                    right: 12vw !important;\r\n                    z-index: 9999999 !important;\r\n                    padding: 12px !important;\r\n                    font-size: 1.5em !important;\r\n                    background: rgba(255, 255, 255, 0.1) !important;\r\n                    backdrop-filter: blur(4px) !important;\r\n                }\r\n            `);\r\n            const head = await rootDoc.querySelector('head');\r\n            if (head) await head.appendChild(styleEl);\r\n        }\r\n\r\n        // ==========================================\r\n        // 3. MUTATIONOBSERVER-BASED SPAWN LOGIC\r\n        // ==========================================\r\n        let isResizerEnabled = null;\r\n\r\n        // Attach â†•ï¸ button to a single SafeElement textarea\r\n        const attachButtonToTextarea = async (ta) => {\r\n            try {\r\n                // Already processed â€” skip\r\n                const marker = await ta.getAttribute('x-cpm-resizer');\r\n                if (marker) return;\r\n\r\n                await ta.setAttribute('x-cpm-resizer', '1');\r\n\r\n                const parent = await ta.getParent();\r\n                if (parent && !(await parent.querySelector('.cpm-resize-btn'))) {\r\n\r\n                    const btn = await rootDoc.createElement('button');\r\n                    const btnId = 'cpm-btn-' + Math.random().toString(36).substring(2, 9);\r\n                    await btn.setAttribute('x-id', btnId);\r\n\r\n                    await btn.setClassName('cpm-resize-btn absolute bottom-2 right-4 text-gray-400 hover:text-white z-[100] p-1 bg-gray-800 rounded opacity-40 hover:opacity-100 transition-opacity text-xs');\r\n                    await btn.setInnerHTML('â†•ï¸');\r\n                    await btn.setAttribute('x-title', 'ì°½ ìµœëŒ€í™” / í¬ê¸° ì¡°ì ˆ');\r\n\r\n                    let isMaximized = false;\r\n\r\n                    await btn.addEventListener('pointerup', async (e) => {\r\n                        let cx = e.clientX ?? e.x ?? (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : null);\r\n                        let cy = e.clientY ?? e.y ?? (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientY : null);\r\n\r\n                        if (typeof cx === 'number' && typeof cy === 'number') {\r\n                            const rect = await btn.getBoundingClientRect();\r\n                            if (rect) {\r\n                                const rLeft = rect.left ?? rect.x;\r\n                                const rTop = rect.top ?? rect.y;\r\n                                const rRight = rect.right ?? (rLeft + rect.width);\r\n                                const rBottom = rect.bottom ?? (rTop + rect.height);\r\n\r\n                                if (cx < rLeft - 5 || cx > rRight + 5 || cy < rTop - 5 || cy > rBottom + 5) {\r\n                                    return;\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        if (!isMaximized) {\r\n                            isMaximized = true;\r\n                            await btn.setInnerHTML('ðŸ”½');\r\n                            await ta.setAttribute('x-cpm-maximized', 'true');\r\n                            await btn.setAttribute('x-cpm-maximized-btn', 'true');\r\n                        } else {\r\n                            isMaximized = false;\r\n                            await btn.setInnerHTML('â†•ï¸');\r\n                            await ta.setAttribute('x-cpm-maximized', 'false');\r\n                            await btn.setAttribute('x-cpm-maximized-btn', 'false');\r\n                        }\r\n                    });\r\n\r\n                    await parent.appendChild(btn);\r\n                }\r\n            } catch (err) {\r\n                console.warn('[CPM Resizer] Failed to attach button:', err);\r\n            }\r\n        };\r\n\r\n        // Scan for unprocessed textareas one-by-one via querySelector\r\n        // NOTE: querySelectorAll returns SafeElement[] which does NOT survive\r\n        // the iframe RPC bridge (arrays of REMOTE_REQUIRED objects lose their\r\n        // private fields during structured clone). querySelector (singular)\r\n        // returns a single SafeElement that gets properly serialized.\r\n        const scanExistingTextareas = async () => {\r\n            let limit = 0;\r\n            while (limit < 100) {\r\n                limit++;\r\n                const ta = await rootDoc.querySelector('textarea:not([x-cpm-resizer])');\r\n                if (!ta) break;\r\n                await attachButtonToTextarea(ta);\r\n            }\r\n        };\r\n\r\n        // Initialize: check enabled, then start observing\r\n        const initResizer = async () => {\r\n            if (isResizerEnabled === null) {\r\n                const arg = await safeGetArg('cpm_enable_chat_resizer');\r\n                isResizerEnabled = (arg === 'false' || arg === false) ? false : true;\r\n            }\r\n            if (isResizerEnabled === false) {\r\n                console.log('[CPM Resizer] Disabled by user setting.');\r\n                return;\r\n            }\r\n\r\n            // Initial scan for textareas already in the DOM\r\n            await scanExistingTextareas();\r\n\r\n            // Set up MutationObserver via RisuAI V3 API\r\n            const body = await rootDoc.querySelector('body');\r\n            if (!body) {\r\n                console.warn('[CPM Resizer] Could not find body element.');\r\n                return;\r\n            }\r\n\r\n            let scanPending = false;\r\n\r\n            const observer = await risuai.createMutationObserver(async (/* mutations - unusable through iframe RPC bridge */) => {\r\n                // NOTE: MutationObserver callback args (SafeClassArray) don't survive\r\n                // the iframe postMessage bridge â€” private fields are lost during structured clone.\r\n                // Instead, we use the callback purely as a \"DOM changed\" trigger with debounce.\r\n                if (isResizerEnabled === false) return;\r\n                if (scanPending) return;\r\n                scanPending = true;\r\n                setTimeout(async () => {\r\n                    scanPending = false;\r\n                    await scanExistingTextareas().catch(() => {});\r\n                }, 200);\r\n            });\r\n\r\n            await observer.observe(body, { childList: true, subtree: true });\r\n            console.log('[CPM Resizer] MutationObserver active on body.');\r\n        };\r\n\r\n        // Clean up old interval timer if it exists (from previous version / hot-reload)\r\n        if (window.__cpmResizerTimer) {\r\n            clearInterval(window.__cpmResizerTimer);\r\n            window.__cpmResizerTimer = null;\r\n        }\r\n\r\n        await initResizer();\r\n\r\n\r\n        console.log('[CPM Resizer] Loaded and ready.');\r\n\r\n    } catch (err) {\r\n        console.error('[CPM Resizer] Initialization error:', err);\r\n    }\r\n})();\r\n","cpm-copilot-manager.js":"//@name CPM Component - Copilot Token Manager\r\n//@display-name Cupcake Copilot Manager\r\n//@api 3.0\r\n//@version 1.5.0\r\n//@author Cupcake\r\n//@update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-copilot-manager.js\r\n\r\n/**\r\n * ======== CUPCAKE PM Sub-Plugin: GitHub Copilot Token Manager ========\r\n *\r\n * GitHub Copilot OAuth í† í°ì„ ê´€ë¦¬í•˜ëŠ” ì„œë¸Œ í”ŒëŸ¬ê·¸ì¸ìž…ë‹ˆë‹¤.\r\n * Cupcake PM ì„¤ì • ì‚¬ì´ë“œë°”ì— \"ðŸ”‘ Copilot\" íƒ­ìœ¼ë¡œ ì§ì ‘ í‘œì‹œë©ë‹ˆë‹¤.\r\n *\r\n * ê¸°ëŠ¥:\r\n *   - í† í° ìƒì„± (GitHub OAuth Device Flow)\r\n *   - í† í° í™•ì¸ (êµ¬ë… ìƒíƒœ, í…”ë ˆë©”íŠ¸ë¦¬, í™œì„± ê¸°ëŠ¥)\r\n *   - í† í° ì œê±°\r\n *   - ëª¨ë¸ ëª©ë¡ ì¡°íšŒ\r\n *   - í• ë‹¹ëŸ‰(ì¿¼í„°) í™•ì¸\r\n *   - ìžë™ ì„¤ì •\r\n */\r\n(() => {\r\n    if (!window.Risuai && !window.risuai) {\r\n        console.warn('[CPM Copilot] RisuAI API not found. Halting.');\r\n        return;\r\n    }\r\n    const risuai = window.risuai || window.Risuai;\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM Copilot] CupcakePM API not found!'); return; }\r\n\r\n    // ==========================================\r\n    // CONSTANTS\r\n    // ==========================================\r\n    const LOG_TAG = '[CPM Copilot]';\r\n    const GITHUB_CLIENT_ID = '01ab8ac9400c4e429b23';\r\n    const TOKEN_ARG_KEY = 'tools_githubCopilotToken';\r\n    const CODE_VERSION = '1.109.2';\r\n    const CHAT_VERSION = '0.37.4';\r\n    const USER_AGENT = `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Code/${CODE_VERSION} Chrome/142.0.7444.265 Electron/39.3.0 Safari/537.36`;\r\n    const PREFIX = 'cpm-copilot';\r\n\r\n    // ==========================================\r\n    // HELPERS\r\n    // ==========================================\r\n\r\n    /**\r\n     * Sanitize a token string: trim whitespace, remove non-printable \r\n     * and non-ASCII characters (zero-width spaces, BOM, etc.)\r\n     * These invisible chars cause:\r\n     *   - \"non ISO-8859-1 code point\" error in browser fetch headers\r\n     *   - \"Bad credentials\" from GitHub API (token corrupted)\r\n     */\r\n    function sanitizeToken(raw) {\r\n        if (!raw) return '';\r\n        // Keep only printable ASCII (0x20-0x7E)\r\n        return raw.replace(/[^\\x20-\\x7E]/g, '').trim();\r\n    }\r\n\r\n    /**\r\n     * Sanitize header values: strip any non-ISO-8859-1 characters.\r\n     * Browser Fetch API throws if header values contain code points > 0xFF.\r\n     */\r\n    function sanitizeHeaders(headers) {\r\n        const clean = {};\r\n        for (const [key, value] of Object.entries(headers)) {\r\n            clean[key] = String(value).replace(/[^\\x00-\\xFF]/g, '');\r\n        }\r\n        return clean;\r\n    }\r\n\r\n    async function getToken() {\r\n        const raw = (await CPM.safeGetArg(TOKEN_ARG_KEY)) || '';\r\n        return sanitizeToken(raw);\r\n    }\r\n\r\n    function setToken(value) {\r\n        // Sanitize before saving so stored token is clean\r\n        CPM.setArg(TOKEN_ARG_KEY, sanitizeToken(value));\r\n    }\r\n\r\n    function toast(msg, duration = 3000) {\r\n        const el = document.createElement('div');\r\n        el.textContent = msg;\r\n        Object.assign(el.style, {\r\n            position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',\r\n            background: '#27272a', color: '#e4e4e7', padding: '10px 20px', borderRadius: '8px',\r\n            fontSize: '14px', zIndex: '99999', boxShadow: '0 4px 12px rgba(0,0,0,0.3)',\r\n            transition: 'opacity 0.3s', opacity: '1'\r\n        });\r\n        document.body.appendChild(el);\r\n        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, duration);\r\n    }\r\n\r\n    function escapeHtml(str) {\r\n        const div = document.createElement('div');\r\n        div.textContent = String(str);\r\n        return div.innerHTML;\r\n    }\r\n\r\n    // ==========================================\r\n    // SMART FETCH: Strategy per endpoint type\r\n    //\r\n    // V3 plugins run in sandboxed iframe; all API calls go through RPC bridge\r\n    // to the host, which calls globalFetch.\r\n    //\r\n    // Problem: RisuAI cloud proxy (sv.risuai.xyz/proxy2) returns 401 for\r\n    // GET requests â€” the cloud proxy likely only supports POST /proxy2.\r\n    // fetchWithProxy uses arg.method directly, so GET requests hit the proxy\r\n    // as GET and get rejected.\r\n    //\r\n    // Solution:\r\n    //   api.github.com / api.githubcopilot.com endpoints:\r\n    //     â†’ plainFetchForce: true (direct browser fetch from host window)\r\n    //     â†’ GitHub API supports CORS (Access-Control-Allow-Origin: *)\r\n    //     â†’ Bypasses proxy entirely, works for both GET and POST\r\n    //\r\n    //   github.com/login/* OAuth endpoints:\r\n    //     â†’ plainFetchDeforce: true (forces proxy route)\r\n    //     â†’ github.com/login doesn't support CORS, must go through proxy\r\n    //     â†’ OAuth calls use POST, which the proxy handles fine\r\n    //\r\n    // body is passed as a plain object (risuFetch handles JSON.stringify).\r\n    // rawResponse: false â†’ returns parsed JSON in result.data.\r\n    // ==========================================\r\n\r\n    /**\r\n     * Wrap risuFetch result ({ ok, data, headers, status }) into a\r\n     * Response-like object so callers can use .ok, .json(), .text(), .status.\r\n     */\r\n    function wrapRisuFetchResult(result) {\r\n        const ok = !!result.ok;\r\n        const status = result.status || (ok ? 200 : 400);\r\n        const data = result.data;\r\n        const headers = result.headers || {};\r\n\r\n        return {\r\n            ok,\r\n            status,\r\n            headers,\r\n            async json() {\r\n                if (typeof data === 'object') return data;\r\n                if (typeof data === 'string') return JSON.parse(data);\r\n                return data;\r\n            },\r\n            async text() {\r\n                if (typeof data === 'string') return data;\r\n                return JSON.stringify(data);\r\n            },\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Check if a risuFetch result represents a real HTTP response\r\n     * (even error like 401/403) vs a network/CORS/fetch failure.\r\n     * Network failures get: { ok:false, data:\"TypeError:...\", headers:{}, status:400 }\r\n     */\r\n    function isRealHttpResponse(result) {\r\n        if (result.headers && Object.keys(result.headers).length > 0) return true;\r\n        if (result.status && result.status !== 400) return true;\r\n        if (result.data && typeof result.data === 'object') return true;\r\n        return false;\r\n    }\r\n\r\n    async function copilotFetch(url, options = {}) {\r\n        const Risu = window.Risuai || window.risuai;\r\n        const method = options.method || (url.includes('github.com/login/') ? 'POST' : 'GET');\r\n        // Sanitize headers to prevent ISO-8859-1 errors in browser fetch\r\n        const headers = sanitizeHeaders(options.headers || {});\r\n\r\n        // Parse body: callers pass JSON string, but risuFetch needs a plain object\r\n        let body = undefined;\r\n        if (options.body) {\r\n            try {\r\n                body = typeof options.body === 'string' ? JSON.parse(options.body) : options.body;\r\n            } catch (e) {\r\n                body = options.body;\r\n            }\r\n        }\r\n\r\n        // --- OAuth endpoints (github.com/login/*) â†’ must use proxy (no CORS) ---\r\n        if (url.includes('github.com/login/')) {\r\n            try {\r\n                console.log(LOG_TAG, `risuFetch [proxy/OAuth] for ${url.substring(0, 80)}...`);\r\n                const result = await Risu.risuFetch(url, {\r\n                    method,\r\n                    headers,\r\n                    body,\r\n                    rawResponse: false,\r\n                    plainFetchDeforce: true,\r\n                });\r\n                console.log(LOG_TAG, `risuFetch [proxy] ok=${result.ok}, status=${result.status}`);\r\n                return wrapRisuFetchResult(result);\r\n            } catch (e) {\r\n                console.error(LOG_TAG, 'risuFetch [proxy/OAuth] failed:', e.message);\r\n                throw new Error(`OAuth ìš”ì²­ ì‹¤íŒ¨: ${e.message}`);\r\n            }\r\n        }\r\n\r\n        // --- API endpoints (api.github.com, api.githubcopilot.com) ---\r\n        // Strategy 1: Direct fetch via plainFetchForce (bypasses proxy, uses CORS)\r\n        try {\r\n            console.log(LOG_TAG, `risuFetch [direct] for ${url.substring(0, 80)}...`);\r\n            const result = await Risu.risuFetch(url, {\r\n                method,\r\n                headers,\r\n                body,\r\n                rawResponse: false,\r\n                plainFetchForce: true,\r\n            });\r\n            if (isRealHttpResponse(result)) {\r\n                console.log(LOG_TAG, `risuFetch [direct] ok=${result.ok}, status=${result.status}`);\r\n                if (!result.ok && result.status === 401) {\r\n                    const errDetail = typeof result.data === 'string' ? result.data.substring(0, 200) : JSON.stringify(result.data);\r\n                    console.warn(LOG_TAG, `401 ì‘ë‹µ ìƒì„¸: ${errDetail}`);\r\n                }\r\n                return wrapRisuFetchResult(result);\r\n            }\r\n            console.log(LOG_TAG, `risuFetch [direct] not a real HTTP response:`, typeof result.data === 'string' ? result.data.substring(0, 150) : 'unknown');\r\n        } catch (e) {\r\n            console.log(LOG_TAG, 'risuFetch [direct] exception:', e.message);\r\n        }\r\n\r\n        // Strategy 2: Proxy via plainFetchDeforce (for Tauri/desktop or if CORS fails)\r\n        try {\r\n            console.log(LOG_TAG, `risuFetch [proxy] for ${url.substring(0, 80)}...`);\r\n            const result = await Risu.risuFetch(url, {\r\n                method,\r\n                headers,\r\n                body,\r\n                rawResponse: false,\r\n                plainFetchDeforce: true,\r\n            });\r\n            if (isRealHttpResponse(result)) {\r\n                console.log(LOG_TAG, `risuFetch [proxy] ok=${result.ok}, status=${result.status}`);\r\n                if (!result.ok && result.status === 401) {\r\n                    const errDetail = typeof result.data === 'string' ? result.data.substring(0, 200) : JSON.stringify(result.data);\r\n                    console.warn(LOG_TAG, `401 [proxy] ì‘ë‹µ ìƒì„¸: ${errDetail}`);\r\n                }\r\n                return wrapRisuFetchResult(result);\r\n            }\r\n            console.log(LOG_TAG, `risuFetch [proxy] not a real HTTP response:`, typeof result.data === 'string' ? result.data.substring(0, 150) : 'unknown');\r\n        } catch (e) {\r\n            console.log(LOG_TAG, 'risuFetch [proxy] exception:', e.message);\r\n        }\r\n\r\n        // Strategy 3: nativeFetch as last resort (uses proxy on web, native on Tauri)\r\n        try {\r\n            console.log(LOG_TAG, `nativeFetch for ${url.substring(0, 80)}...`);\r\n            const res = await Risu.nativeFetch(url, {\r\n                method,\r\n                headers,\r\n                body: body ? JSON.stringify(body) : undefined,\r\n            });\r\n            return res;\r\n        } catch (e) {\r\n            console.log(LOG_TAG, 'nativeFetch exception:', e.message);\r\n        }\r\n\r\n        throw new Error('ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì‹¤íŒ¨: ëª¨ë“  ìš”ì²­ ë°©ì‹ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. RisuAI ë°ìŠ¤í¬íƒ‘ ì•±ì„ ì‚¬ìš©í•˜ê±°ë‚˜, RisuAI ì„¤ì • â†’ ê¸°íƒ€ ë´‡ ì„¤ì • â†’ \"Use plain fetch instead of server\"ë¥¼ í™œì„±í™”í•˜ì„¸ìš”.');\r\n    }\r\n\r\n    // ==========================================\r\n    // COPILOT API FUNCTIONS\r\n    // ==========================================\r\n    async function requestDeviceCode() {\r\n        const res = await copilotFetch('https://github.com/login/device/code', {\r\n            method: 'POST',\r\n            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json', 'User-Agent': USER_AGENT },\r\n            body: JSON.stringify({ client_id: GITHUB_CLIENT_ID, scope: 'user:email' }),\r\n        });\r\n        if (!res.ok) throw new Error(`ë””ë°”ì´ìŠ¤ ì½”ë“œ ìš”ì²­ ì‹¤íŒ¨ (${res.status}): ${await res.text()}`);\r\n        return await res.json();\r\n    }\r\n\r\n    async function exchangeAccessToken(deviceCode) {\r\n        const res = await copilotFetch('https://github.com/login/oauth/access_token', {\r\n            method: 'POST',\r\n            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json', 'User-Agent': USER_AGENT },\r\n            body: JSON.stringify({ client_id: GITHUB_CLIENT_ID, device_code: deviceCode, grant_type: 'urn:ietf:params:oauth:grant-type:device_code' }),\r\n        });\r\n        if (!res.ok) throw new Error(`ì•¡ì„¸ìŠ¤ í† í° ìš”ì²­ ì‹¤íŒ¨ (${res.status}): ${await res.text()}`);\r\n        const data = await res.json();\r\n        if (data.error === 'authorization_pending') throw new Error('ì¸ì¦ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. GitHubì—ì„œ ì½”ë“œë¥¼ ìž…ë ¥ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.');\r\n        if (!data.access_token) throw new Error(`ì•¡ì„¸ìŠ¤ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${JSON.stringify(data)}`);\r\n        return data.access_token;\r\n    }\r\n\r\n    async function checkTokenStatus(token) {\r\n        const cleanToken = sanitizeToken(token);\r\n        if (!cleanToken) throw new Error('í† í°ì´ ë¹„ì–´ìžˆìŠµë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.');\r\n        if (cleanToken !== token) {\r\n            console.warn(LOG_TAG, `í† í°ì—ì„œ ë¹„ì •ìƒ ë¬¸ìžê°€ ì œê±°ë¨ (ì›ë³¸ ${token.length}ìž â†’ ì •ì œ ${cleanToken.length}ìž)`);\r\n        }\r\n        const res = await copilotFetch('https://api.github.com/copilot_internal/v2/token', {\r\n            method: 'GET',\r\n            headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${cleanToken}`, 'User-Agent': USER_AGENT },\r\n        });\r\n        if (!res.ok) {\r\n            const errBody = await res.text();\r\n            if (res.status === 401) {\r\n                const parsed = (() => { try { return JSON.parse(errBody); } catch { return null; } })();\r\n                if (parsed?.message === 'Bad credentials') {\r\n                    throw new Error('í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ðŸ”‘ í† í° ìƒì„± ë²„íŠ¼ìœ¼ë¡œ ìƒˆ í† í°ì„ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.');\r\n                }\r\n            }\r\n            throw new Error(`ìƒíƒœ í™•ì¸ ì‹¤íŒ¨ (${res.status}): ${errBody}`);\r\n        }\r\n        return await res.json();\r\n    }\r\n\r\n    async function getTidToken(token) {\r\n        const data = await checkTokenStatus(token);\r\n        if (!data.token) throw new Error('Tid í† í°ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');\r\n        return data;\r\n    }\r\n\r\n    async function fetchModelList(token) {\r\n        const tidData = await getTidToken(token);\r\n        const res = await copilotFetch('https://api.githubcopilot.com/models', {\r\n            method: 'GET',\r\n            headers: {\r\n                'Accept': 'application/json', 'Authorization': `Bearer ${tidData.token}`,\r\n                'Editor-Version': `vscode/${CODE_VERSION}`, 'Editor-Plugin-Version': `copilot-chat/${CHAT_VERSION}`,\r\n                'Copilot-Integration-Id': 'vscode-chat', 'User-Agent': USER_AGENT,\r\n            },\r\n        });\r\n        if (!res.ok) throw new Error(`ëª¨ë¸ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨ (${res.status}): ${await res.text()}`);\r\n        return await res.json();\r\n    }\r\n\r\n    async function checkQuota(token) {\r\n        const tidData = await getTidToken(token);\r\n        const quotaInfo = { plan: tidData.sku || 'unknown' };\r\n\r\n        // 1. Extract useful fields from token endpoint response\r\n        const tokenMeta = {};\r\n        const skipKeys = ['token', 'tracking_id'];\r\n        for (const [k, v] of Object.entries(tidData)) {\r\n            if (!skipKeys.includes(k) && k !== 'sku') {\r\n                tokenMeta[k] = v;\r\n            }\r\n        }\r\n        if (Object.keys(tokenMeta).length > 0) {\r\n            quotaInfo.token_meta = tokenMeta;\r\n        }\r\n\r\n        // 2. Copilot usage / quota via copilot_internal/user\r\n        //    This is the correct endpoint for quota_snapshots (premium_interactions, chat, completions)\r\n        //    Reference: copilotstats.com uses this same endpoint\r\n        try {\r\n            console.log(LOG_TAG, 'Fetching Copilot quota via /copilot_internal/user...');\r\n            const userRes = await copilotFetch('https://api.github.com/copilot_internal/user', {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Accept': 'application/json',\r\n                    'Authorization': `Bearer ${token}`,\r\n                    'Content-Type': 'application/json',\r\n                    'User-Agent': USER_AGENT,\r\n                },\r\n            });\r\n            if (userRes.ok) {\r\n                const userData = await userRes.json();\r\n                quotaInfo.copilot_user = userData;\r\n                if (userData.quota_snapshots) {\r\n                    quotaInfo.quota_snapshots = userData.quota_snapshots;\r\n                }\r\n                console.log(LOG_TAG, 'Copilot user data retrieved successfully.');\r\n            } else {\r\n                console.warn(LOG_TAG, `copilot_internal/user returned ${userRes.status}`);\r\n            }\r\n        } catch (e) { console.warn(LOG_TAG, 'Copilot user quota check failed:', e); }\r\n\r\n        return quotaInfo;\r\n    }\r\n\r\n    // ==========================================\r\n    // INLINE RESULT RENDERER (for settingsTab)\r\n    // ==========================================\r\n    function showResult(html) {\r\n        const c = document.getElementById(`${PREFIX}-result`);\r\n        if (!c) return;\r\n        c.style.display = 'block';\r\n        c.innerHTML = html;\r\n        c.scrollIntoView({ behavior: 'smooth', block: 'nearest' });\r\n    }\r\n    function showLoading(msg = 'ì²˜ë¦¬ ì¤‘...') {\r\n        showResult(`<div class=\"text-center py-6 text-gray-400\"><div class=\"text-2xl mb-2\">â³</div><div>${msg}</div></div>`);\r\n    }\r\n    function showError(msg) {\r\n        showResult(`<div class=\"bg-red-950 border border-red-800 rounded-lg p-4 text-red-300\"><strong>âŒ ì˜¤ë¥˜:</strong> ${escapeHtml(msg)}</div>`);\r\n    }\r\n    function showSuccess(msg) {\r\n        showResult(`<div class=\"bg-green-950 border border-green-800 rounded-lg p-4 text-green-300\">${msg}</div>`);\r\n    }\r\n\r\n    async function refreshTokenDisplay() {\r\n        const el = document.getElementById(`${PREFIX}-token-display`);\r\n        if (!el) return;\r\n        const token = await getToken();\r\n        if (token && token.length > 16) {\r\n            el.textContent = token.substring(0, 8) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + token.substring(token.length - 4);\r\n        } else if (token) {\r\n            el.textContent = token;\r\n        } else {\r\n            el.textContent = 'í† í° ì—†ìŒ';\r\n        }\r\n    }\r\n\r\n    // ==========================================\r\n    // ACTION HANDLERS (exposed on window for inline onclick)\r\n    // ==========================================\r\n    const actions = {};\r\n\r\n    actions.manualSave = async () => {\r\n        const input = document.getElementById(`${PREFIX}-manual-input`);\r\n        if (!input) return;\r\n        const val = input.value.trim();\r\n        if (!val) { toast('í† í°ì„ ìž…ë ¥í•˜ì„¸ìš”.'); return; }\r\n        setToken(val);\r\n        input.value = '';\r\n        await refreshTokenDisplay();\r\n        toast('í† í°ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n        showSuccess('<strong>âœ… ì„±ê³µ!</strong> ì§ì ‘ ìž…ë ¥í•œ í† í°ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n    };\r\n\r\n    actions.copyToken = async () => {\r\n        const token = await getToken();\r\n        if (!token) { toast('ì €ìž¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }\r\n        try { await navigator.clipboard.writeText(token); } catch {\r\n            const ta = document.createElement('textarea'); ta.value = token; ta.style.cssText = 'position:fixed;left:-9999px';\r\n            document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();\r\n        }\r\n        toast('í† í°ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n    };\r\n\r\n    actions.generate = async () => {\r\n        const DIALOG_ID = `${PREFIX}-generate-dialog`;\r\n        document.getElementById(DIALOG_ID)?.remove();\r\n        try {\r\n            showLoading('GitHub ë””ë°”ì´ìŠ¤ ì½”ë“œ ìš”ì²­ ì¤‘...');\r\n            const deviceCode = await requestDeviceCode();\r\n            const rc = document.getElementById(`${PREFIX}-result`); if (rc) rc.style.display = 'none';\r\n\r\n            const dialog = document.createElement('div');\r\n            dialog.id = DIALOG_ID;\r\n            dialog.className = 'fixed inset-0 flex items-center justify-center p-2';\r\n            dialog.style.cssText = 'z-index:10002; background:rgba(0,0,0,0.6);';\r\n            dialog.innerHTML = `\r\n                <div class=\"bg-gray-900 rounded-xl w-full max-w-md border border-gray-700 overflow-hidden\">\r\n                    <div class=\"flex items-center justify-between px-5 py-4 border-b border-gray-700\">\r\n                        <h3 class=\"text-lg font-bold text-white\">ðŸ”‘ GitHub Copilot í† í° ìƒì„±</h3>\r\n                        <button onclick=\"document.getElementById('${DIALOG_ID}')?.remove()\" class=\"text-gray-400 hover:text-white text-xl px-2\">âœ•</button>\r\n                    </div>\r\n                    <div class=\"p-5\">\r\n                        <div class=\"bg-gray-800 rounded-lg p-5 mb-4 space-y-4\">\r\n                            <div class=\"flex items-start\"><span class=\"bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-3 shrink-0\">1</span>\r\n                                <span class=\"text-gray-200\"><a href=\"https://github.com/login/device\" target=\"_blank\" class=\"text-blue-400 underline\">https://github.com/login/device</a> ë¡œ ì´ë™í•˜ì„¸ìš”</span></div>\r\n                            <div class=\"flex items-start\"><span class=\"bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-3 shrink-0\">2</span>\r\n                                <div class=\"flex-1\"><span class=\"text-gray-200\">ì•„ëž˜ ì½”ë“œë¥¼ ìž…ë ¥í•˜ì„¸ìš”:</span>\r\n                                    <div class=\"flex items-center justify-between bg-gray-700 p-3 rounded-md mt-2\">\r\n                                        <span class=\"font-mono text-2xl tracking-widest text-white font-bold\" id=\"${DIALOG_ID}-code\">${deviceCode.user_code}</span>\r\n                                        <button onclick=\"navigator.clipboard.writeText(document.getElementById('${DIALOG_ID}-code').textContent).then(()=>{})\" class=\"bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded\">ë³µì‚¬</button>\r\n                                    </div></div></div>\r\n                            <div class=\"flex items-start\"><span class=\"bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-3 shrink-0\">3</span>\r\n                                <span class=\"text-gray-200\">GitHub ê³„ì •ìœ¼ë¡œ ì¸ì¦í•˜ì„¸ìš”</span></div>\r\n                        </div>\r\n                        <p class=\"text-gray-400 text-center text-sm mb-4\">ì¸ì¦ì„ ì™„ë£Œí•œ í›„ í™•ì¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>\r\n                        <div class=\"flex justify-end space-x-3\">\r\n                            <button onclick=\"document.getElementById('${DIALOG_ID}')?.remove()\" class=\"bg-gray-700 hover:bg-gray-600 text-white px-5 py-2 rounded-lg text-sm\">ì·¨ì†Œ</button>\r\n                            <button id=\"${DIALOG_ID}-confirm\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-lg text-sm font-bold\">í™•ì¸</button>\r\n                        </div>\r\n                    </div>\r\n                </div>`;\r\n            dialog.addEventListener('keydown', (e) => { if (e.key === 'Escape') dialog.remove(); });\r\n            document.body.appendChild(dialog);\r\n\r\n            document.getElementById(`${DIALOG_ID}-confirm`).addEventListener('click', async function () {\r\n                this.disabled = true; this.textContent = 'í™•ì¸ ì¤‘...';\r\n                try {\r\n                    const accessToken = await exchangeAccessToken(deviceCode.device_code);\r\n                    setToken(accessToken);\r\n                    dialog.remove();\r\n                    await refreshTokenDisplay();\r\n                    toast('GitHub Copilot í† í°ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');\r\n                    showSuccess('<strong>âœ… ì„±ê³µ!</strong> í† í°ì´ ìƒì„±ë˜ê³  ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n                } catch (e) { this.disabled = false; this.textContent = 'í™•ì¸'; toast(e.message); }\r\n            });\r\n        } catch (e) { showError(e.message); }\r\n    };\r\n\r\n    actions.verify = async () => {\r\n        const token = await getToken();\r\n        if (!token) { showError('ì €ìž¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.'); return; }\r\n        showLoading('í† í° ìƒíƒœ í™•ì¸ ì¤‘...');\r\n        try {\r\n            const data = await checkTokenStatus(token);\r\n            const sku = data.sku || 'ì•Œ ìˆ˜ ì—†ìŒ';\r\n            const telemetry = data.telemetry || 'ì•Œ ìˆ˜ ì—†ìŒ';\r\n            const expiresAt = data.expires_at ? new Date(data.expires_at * 1000).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';\r\n            const features = Object.entries(data).filter(([, v]) => typeof v === 'boolean' && v).map(([k]) => k);\r\n            const ci = `<span class=\"text-green-400 mr-1\">âœ“</span>`, xi = `<span class=\"text-red-400 mr-1\">âœ—</span>`;\r\n            showResult(`\r\n                <div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3\">\r\n                    <h4 class=\"text-white font-bold mb-3\">êµ¬ë… ì •ë³´</h4>\r\n                    <div class=\"bg-gray-900 p-3 rounded space-y-1 text-sm text-gray-200\">\r\n                        <div>${sku === 'monthly_subscriber' ? ci : xi}<strong>êµ¬ë…:</strong> ${escapeHtml(sku)}</div>\r\n                        <div>${telemetry === 'disabled' ? ci : xi}<strong>í…”ë ˆë©”íŠ¸ë¦¬:</strong> ${escapeHtml(telemetry)}</div>\r\n                        <div class=\"text-gray-500 text-xs pt-1\">í† í° ë§Œë£Œ: ${expiresAt}</div>\r\n                    </div>\r\n                </div>\r\n                ${features.length > 0 ? `<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4\">\r\n                    <h4 class=\"text-white font-bold mb-3\">í™œì„± ê¸°ëŠ¥ (${features.length})</h4>\r\n                    <div class=\"bg-gray-900 p-3 rounded grid grid-cols-1 sm:grid-cols-2 gap-1 text-xs text-gray-300\">\r\n                        ${features.map(f => `<div>${ci}${escapeHtml(f)}</div>`).join('')}\r\n                    </div></div>` : ''}`);\r\n        } catch (e) { showError(e.message); }\r\n    };\r\n\r\n    actions.remove = async () => {\r\n        const token = await getToken();\r\n        if (!token) { toast('ì´ë¯¸ í† í°ì´ ë¹„ì–´ìžˆìŠµë‹ˆë‹¤.'); return; }\r\n        if (!confirm('ì •ë§ë¡œ ì €ìž¥ëœ GitHub Copilot í† í°ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì œê±° í›„ì—ëŠ” ë‹¤ì‹œ í† í°ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.')) return;\r\n        setToken('');\r\n        await refreshTokenDisplay();\r\n        toast('í† í°ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');\r\n        showResult(`<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 text-yellow-300\"><strong>ðŸ—‘ï¸ í† í° ì œê±° ì™„ë£Œ.</strong> í•„ìš” ì‹œ ë‹¤ì‹œ ìƒì„±í•˜ì„¸ìš”.</div>`);\r\n    };\r\n\r\n    actions.models = async () => {\r\n        const token = await getToken();\r\n        if (!token) { showError('ì €ìž¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.'); return; }\r\n        showLoading('ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì¤‘...');\r\n        try {\r\n            const data = await fetchModelList(token);\r\n            const ids = (data.data || []).map(m => m.id);\r\n            showResult(`\r\n                <div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3\">\r\n                    <h4 class=\"text-white font-bold mb-3\">ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ (${ids.length}ê°œ)</h4>\r\n                    <div class=\"bg-gray-900 p-3 rounded max-h-48 overflow-y-auto font-mono text-xs text-gray-300\">\r\n                        ${ids.map(id => `<div class=\"py-1 border-b border-gray-800\">${escapeHtml(id)}</div>`).join('')}\r\n                    </div>\r\n                </div>\r\n                <details class=\"bg-gray-800 border border-gray-700 rounded-lg overflow-hidden\">\r\n                    <summary class=\"p-4 text-white font-bold cursor-pointer select-none\">ëª¨ë¸ ìƒì„¸ ì •ë³´ (í´ë¦­í•˜ì—¬ íŽ¼ì¹˜ê¸°)</summary>\r\n                    <div class=\"px-4 pb-4\"><div class=\"bg-gray-900 p-3 rounded max-h-72 overflow-y-auto font-mono text-[11px] text-gray-500 whitespace-pre-wrap break-all\">${escapeHtml(JSON.stringify(data, null, 2))}</div></div>\r\n                </details>`);\r\n        } catch (e) { showError(e.message); }\r\n    };\r\n\r\n    actions.quota = async () => {\r\n        const token = await getToken();\r\n        if (!token) { showError('ì €ìž¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.'); return; }\r\n        showLoading('í• ë‹¹ëŸ‰ ì •ë³´ ì¡°íšŒ ì¤‘...');\r\n        try {\r\n            const q = await checkQuota(token);\r\n\r\n            // === 1. Subscription plan ===\r\n            const planLabels = {\r\n                'copilot_for_individuals_subscriber': 'Copilot Individual',\r\n                'copilot_for_individuals_pro_subscriber': 'Copilot Pro',\r\n                'plus_monthly_subscriber_quota': 'Copilot Pro+ (ì›”ê°„)',\r\n                'plus_yearly_subscriber_quota': 'Copilot Pro+ (ì—°ê°„)',\r\n            };\r\n            const planDisplay = planLabels[q.plan] || q.plan;\r\n            let html = `<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3\">\r\n                <h4 class=\"text-white font-bold mb-3\">ðŸ“Š êµ¬ë… í”Œëžœ</h4>\r\n                <div class=\"bg-gray-900 p-3 rounded text-sm text-gray-200\">\r\n                    <div class=\"mb-1\"><strong>í”Œëžœ:</strong> ${escapeHtml(planDisplay)}</div>\r\n                    <div class=\"text-gray-500 text-xs\">(SKU: ${escapeHtml(q.plan)})</div>\r\n                </div></div>`;\r\n\r\n            // === 2. Copilot í• ë‹¹ëŸ‰ (quota_snapshots from copilot_internal/user) ===\r\n            if (q.quota_snapshots) {\r\n                const snap = q.quota_snapshots;\r\n\r\n                // 2a. Premium Interactions (ë©”ì¸ í• ë‹¹ëŸ‰)\r\n                if (snap.premium_interactions) {\r\n                    const pi = snap.premium_interactions;\r\n                    const remaining = pi.remaining ?? 0;\r\n                    const entitlement = pi.entitlement ?? 0;\r\n                    const used = entitlement - remaining;\r\n                    const pctRemaining = pi.percent_remaining ?? (entitlement > 0 ? (remaining / entitlement * 100) : 0);\r\n                    const color = pctRemaining > 70 ? '#4ade80' : (pctRemaining > 30 ? '#facc15' : '#f87171');\r\n                    const overage = pi.overage_permitted ? 'í—ˆìš©' : 'ë¹„í—ˆìš©';\r\n                    html += `<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3\">\r\n                        <h4 class=\"text-white font-bold mb-3\">ðŸŽ¯ í”„ë¦¬ë¯¸ì—„ ìš”ì²­ í• ë‹¹ëŸ‰</h4>\r\n                        <div class=\"bg-gray-900 p-3 rounded text-sm text-gray-300\">\r\n                            <div class=\"mb-2 flex items-baseline justify-between\">\r\n                                <span><strong>ë‚¨ì€ ìš”ì²­:</strong></span>\r\n                                <span style=\"color:${color}; font-size:1.4em; font-weight:bold;\">${remaining} <span style=\"font-size:0.6em; color:#9ca3af;\">/ ${entitlement}</span></span>\r\n                            </div>\r\n                            <div class=\"bg-gray-700 rounded-full h-3 overflow-hidden mb-2\"><div style=\"background:${color}; width:${pctRemaining}%; height:100%; transition:width 0.3s; border-radius:9999px;\"></div></div>\r\n                            <div class=\"flex justify-between text-xs text-gray-400\">\r\n                                <span>ì‚¬ìš©: ${used}íšŒ</span>\r\n                                <span>${pctRemaining.toFixed(1)}% ë‚¨ìŒ</span>\r\n                            </div>\r\n                            ${pi.unlimited ? '<div class=\"text-green-400 text-xs mt-1 font-bold\">â™¾ï¸ ë¬´ì œí•œ</div>' : ''}\r\n                            <div class=\"text-gray-500 text-xs mt-1\">ì´ˆê³¼ í—ˆìš©: ${overage}</div>\r\n                            ${pi.reset_date ? `<div class=\"text-gray-500 text-xs\">ë¦¬ì…‹: ${new Date(pi.reset_date).toLocaleString('ko-KR')}</div>` : ''}\r\n                        </div></div>`;\r\n                }\r\n\r\n                // 2b. Other quotas (chat, completions, etc.)\r\n                const otherQuotas = Object.entries(snap).filter(([k]) => k !== 'premium_interactions');\r\n                if (otherQuotas.length > 0) {\r\n                    let oqHtml = '';\r\n                    for (const [key, quota] of otherQuotas) {\r\n                        const label = key.replace(/_/g, ' ');\r\n                        if (quota.unlimited) {\r\n                            oqHtml += `<div class=\"flex items-center justify-between py-2 border-b border-gray-700 last:border-0\">\r\n                                <span class=\"capitalize text-xs text-gray-300\">${escapeHtml(label)}</span>\r\n                                <span class=\"text-green-400 text-xs font-bold\">â™¾ï¸ ë¬´ì œí•œ</span>\r\n                            </div>`;\r\n                        } else {\r\n                            const rem = quota.remaining ?? 0;\r\n                            const ent = quota.entitlement ?? 0;\r\n                            const pct = quota.percent_remaining ?? (ent > 0 ? (rem / ent * 100) : 0);\r\n                            const clr = pct > 70 ? '#4ade80' : (pct > 30 ? '#facc15' : '#f87171');\r\n                            oqHtml += `<div class=\"py-2 border-b border-gray-700 last:border-0\">\r\n                                <div class=\"flex items-center justify-between mb-1\">\r\n                                    <span class=\"capitalize text-xs text-gray-300\">${escapeHtml(label)}</span>\r\n                                    <span class=\"text-xs\" style=\"color:${clr};\">${rem} / ${ent}</span>\r\n                                </div>\r\n                                <div class=\"bg-gray-700 rounded-full h-1.5 overflow-hidden\"><div style=\"background:${clr}; width:${pct}%; height:100%; border-radius:9999px;\"></div></div>\r\n                            </div>`;\r\n                        }\r\n                    }\r\n                    html += `<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 mb-3\">\r\n                        <h4 class=\"text-white font-bold mb-3\">ðŸ“‹ ê¸°íƒ€ í• ë‹¹ëŸ‰</h4>\r\n                        <div class=\"bg-gray-900 p-3 rounded\">${oqHtml}</div></div>`;\r\n                }\r\n            } else {\r\n                html += `<div class=\"bg-yellow-950 border border-yellow-800 rounded-lg p-4 mb-3\">\r\n                    <h4 class=\"text-yellow-300 font-bold mb-2\">âš ï¸ í• ë‹¹ëŸ‰ ì •ë³´ ì—†ìŒ</h4>\r\n                    <div class=\"text-yellow-200 text-sm\">\r\n                        <p class=\"mb-1\">Copilot í• ë‹¹ëŸ‰ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤.</p>\r\n                        <p class=\"text-yellow-400 text-xs\">ì´ í”Œëžœì—ì„œ í• ë‹¹ëŸ‰ APIë¥¼ ì§€ì›í•˜ì§€ ì•Šê±°ë‚˜, í† í° ê¶Œí•œì´ ë¶€ì¡±í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. <a href=\"https://github.com/settings/copilot\" target=\"_blank\" style=\"color:#60a5fa; text-decoration:underline;\">GitHub ì„¤ì •</a>ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>\r\n                    </div></div>`;\r\n            }\r\n\r\n            // === 3. Token features (collapsible) ===\r\n            if (q.token_meta && Object.keys(q.token_meta).length > 0) {\r\n                const tm = q.token_meta;\r\n                const boolFeatures = [];\r\n                const otherFields = {};\r\n                for (const [k, v] of Object.entries(tm)) {\r\n                    if (typeof v === 'boolean') {\r\n                        boolFeatures.push({ key: k, enabled: v });\r\n                    } else if (k === 'expires_at') {\r\n                        otherFields[k] = new Date(v * 1000).toLocaleString('ko-KR');\r\n                    } else if (k === 'refresh_in') {\r\n                        otherFields[k] = `${v}ì´ˆ`;\r\n                    } else {\r\n                        otherFields[k] = v;\r\n                    }\r\n                }\r\n                let featHtml = '';\r\n                if (boolFeatures.length > 0) {\r\n                    featHtml += `<div class=\"grid grid-cols-2 gap-1 mb-2\">`;\r\n                    for (const f of boolFeatures) {\r\n                        featHtml += `<div class=\"text-xs\"><span class=\"${f.enabled ? 'text-green-400' : 'text-gray-600'}\">${f.enabled ? 'âœ…' : 'âŒ'}</span> ${escapeHtml(f.key)}</div>`;\r\n                    }\r\n                    featHtml += `</div>`;\r\n                }\r\n                if (Object.keys(otherFields).length > 0) {\r\n                    featHtml += `<div class=\"text-xs text-gray-400 font-mono whitespace-pre-wrap mt-2\">${escapeHtml(JSON.stringify(otherFields, null, 2))}</div>`;\r\n                }\r\n                html += `<details class=\"bg-gray-800 border border-gray-700 rounded-lg overflow-hidden mb-3\">\r\n                    <summary class=\"p-4 text-white font-bold cursor-pointer select-none\">ðŸ”§ í† í° ê¸°ëŠ¥ ìƒì„¸ (í´ë¦­í•˜ì—¬ íŽ¼ì¹˜ê¸°)</summary>\r\n                    <div class=\"px-4 pb-4\">${featHtml}</div>\r\n                </details>`;\r\n            }\r\n\r\n            // === 4. Raw API response (collapsible) ===\r\n            if (q.copilot_user) {\r\n                html += `<details class=\"bg-gray-800 border border-gray-700 rounded-lg overflow-hidden\">\r\n                    <summary class=\"p-4 text-gray-400 font-bold cursor-pointer select-none text-sm\">ðŸ” API ì›ë³¸ ì‘ë‹µ (í´ë¦­í•˜ì—¬ íŽ¼ì¹˜ê¸°)</summary>\r\n                    <div class=\"px-4 pb-4\"><div class=\"bg-gray-900 p-3 rounded max-h-72 overflow-y-auto font-mono text-[11px] text-gray-500 whitespace-pre-wrap break-all\">${escapeHtml(JSON.stringify(q.copilot_user, null, 2))}</div></div>\r\n                </details>`;\r\n            }\r\n\r\n            showResult(html || `<div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4 text-yellow-300\">í• ë‹¹ëŸ‰ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`);\r\n        } catch (e) { showError(e.message); }\r\n    };\r\n\r\n    actions.autoConfig = async () => {\r\n        const token = await getToken();\r\n        if (!token) { showError('ì €ìž¥ëœ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í† í°ì„ ìƒì„±í•˜ì„¸ìš”.'); return; }\r\n        if (!confirm(`GitHub Copilot ìžë™ ì„¤ì •ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nCustom Modelì— ë‹¤ìŒ ì„¤ì •ì´ ìžë™ ì¶”ê°€ë©ë‹ˆë‹¤:\\n  URL: https://api.githubcopilot.com/chat/completions\\n  ëª¨ë¸: gpt-4.1\\n  í¬ë§·: OpenAI\\n\\nê¸°ì¡´ Copilot ì»¤ìŠ¤í…€ ëª¨ë¸ì´ ìžˆìœ¼ë©´ ë®ì–´ì”ë‹ˆë‹¤.`)) return;\r\n        showLoading('ìžë™ ì„¤ì • ì ìš© ì¤‘...');\r\n        try {\r\n            // Check if addCustomModel API is available\r\n            if (typeof CPM.addCustomModel !== 'function') {\r\n                showError('CupcakePM ë²„ì „ì´ ë‚®ì•„ ìžë™ ì„¤ì •ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Provider Managerë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.');\r\n                return;\r\n            }\r\n            const modelDef = {\r\n                name: 'ðŸ¤– Copilot (GPT-4.1)',\r\n                model: 'gpt-4.1',\r\n                url: 'https://api.githubcopilot.com/chat/completions',\r\n                key: '',\r\n                format: 'openai',\r\n                sysfirst: false,\r\n                mergesys: false,\r\n                altrole: false,\r\n                mustuser: false,\r\n                maxout: false,\r\n                decoupled: false,\r\n                thought: false,\r\n                reasoning: 'none',\r\n                verbosity: 'none',\r\n                thinking: 'none',\r\n                tok: 'o200k_base',\r\n                customParams: '',\r\n            };\r\n            const result = CPM.addCustomModel(modelDef, 'copilot-auto');\r\n            if (result.success) {\r\n                toast('Copilot ì»¤ìŠ¤í…€ ëª¨ë¸ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');\r\n                showSuccess(`<strong>âœ… ìžë™ ì„¤ì • ì™„ë£Œ!</strong>\r\n                    <p class=\"mt-2 text-sm\">ë‹¤ìŒ Custom Modelì´ ${result.created ? 'ìƒì„±' : 'ì—…ë°ì´íŠ¸'}ë˜ì—ˆìŠµë‹ˆë‹¤:</p>\r\n                    <div class=\"bg-gray-900 rounded p-3 mt-2 text-xs font-mono text-gray-300 space-y-1\">\r\n                        <div><strong>ì´ë¦„:</strong> ${escapeHtml(modelDef.name)}</div>\r\n                        <div><strong>URL:</strong> ${escapeHtml(modelDef.url)}</div>\r\n                        <div><strong>ëª¨ë¸:</strong> ${escapeHtml(modelDef.model)}</div>\r\n                        <div><strong>Key:</strong> Copilot í† í° ìžë™ ì‚¬ìš© (githubcopilot.com URL ê°ì§€)</div>\r\n                    </div>\r\n                    <p class=\"mt-3 text-xs text-yellow-300\">ðŸ’¡ RisuAI ë©”ì¸ UIì—ì„œ [Cupcake PM] [Custom] ðŸ¤– Copilot (GPT-4.1) ì„ ì„ íƒí•˜ë©´ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.<br>ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ë ¤ë©´ ì„¤ì •ì„ ë‹«ê³  í”ŒëŸ¬ê·¸ì¸ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì„¸ìš”.</p>`);\r\n            } else {\r\n                showError('ì»¤ìŠ¤í…€ ëª¨ë¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));\r\n            }\r\n        } catch (e) { showError(e.message); }\r\n    };\r\n\r\n    // Expose on window for inline onclick (settings tab HTML uses these)\r\n    window._cpmCopilot = actions;\r\n\r\n    // ==========================================\r\n    // REGISTER AS SETTINGS TAB (appears in sidebar)\r\n    // ==========================================\r\n    const BTN_CLASS = 'w-full flex flex-col items-center justify-center p-4 rounded-lg bg-gray-800 hover:bg-blue-600 text-gray-200 transition-colors border border-gray-700 cursor-pointer text-sm font-medium';\r\n    const BTN_RED_CLASS = 'w-full flex flex-col items-center justify-center p-4 rounded-lg bg-gray-800 hover:bg-red-600 text-gray-200 transition-colors border border-gray-700 cursor-pointer text-sm font-medium';\r\n\r\n    CPM.registerProvider({\r\n        name: 'Copilot',\r\n        // No models or fetcher â€” this is a tool, not a provider\r\n        settingsTab: {\r\n            id: 'tab-copilot',\r\n            icon: 'ðŸ”‘',\r\n            label: 'Copilot',\r\n            exportKeys: [TOKEN_ARG_KEY],\r\n            renderContent: async (renderInput) => {\r\n                const token = await getToken();\r\n                const masked = token\r\n                    ? (token.length > 16 ? token.substring(0, 8) + 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' + token.substring(token.length - 4) : token)\r\n                    : 'í† í° ì—†ìŒ';\r\n\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-blue-400 mb-6 pb-3 border-b border-gray-700\">ðŸ”‘ GitHub Copilot í† í° ê´€ë¦¬ìž</h3>\r\n                    <p class=\"text-blue-300 font-semibold mb-6 border-l-4 border-blue-500 pl-4 py-1\">\r\n                        GitHub Copilot OAuth í† í°ì„ ìƒì„±Â·í™•ì¸Â·ì œê±°í•˜ê³ , ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ê³¼ í• ë‹¹ëŸ‰ì„ ì¡°íšŒí•©ë‹ˆë‹¤.\r\n                    </p>\r\n\r\n                    <!-- Current Token Display -->\r\n                    <div class=\"mb-4\">\r\n                        <label class=\"block text-sm font-medium text-gray-400 mb-2\">í˜„ìž¬ ì €ìž¥ëœ í† í°</label>\r\n                        <div class=\"flex items-center space-x-2\">\r\n                            <div id=\"${PREFIX}-token-display\" class=\"flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-gray-300 font-mono text-sm select-all truncate\">${escapeHtml(masked)}</div>\r\n                            <button onclick=\"window._cpmCopilot.copyToken()\" class=\"bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm font-bold shrink-0\" title=\"í† í° ë³µì‚¬\">ðŸ“‹ ë³µì‚¬</button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <!-- Manual Token Input -->\r\n                    <div class=\"mb-6\">\r\n                        <label class=\"block text-sm font-medium text-gray-400 mb-2\">í† í° ì§ì ‘ ìž…ë ¥</label>\r\n                        <div class=\"flex items-center space-x-2\">\r\n                            <input id=\"${PREFIX}-manual-input\" type=\"text\" placeholder=\"ghu_xxxx ë˜ëŠ” gho_xxxx í† í°ì„ ë¶™ì—¬ë„£ê¸°...\" class=\"flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-gray-200 font-mono text-sm focus:border-blue-500 focus:outline-none\" />\r\n                            <button onclick=\"window._cpmCopilot.manualSave()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold shrink-0\">ðŸ’¾ ì €ìž¥</button>\r\n                        </div>\r\n                        <p class=\"text-gray-500 text-xs mt-1\">GitHubì—ì„œ ì§ì ‘ ë°œê¸‰ë°›ì€ í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ ìž…ë ¥í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.</p>\r\n                    </div>\r\n\r\n                    <!-- Action Buttons Grid -->\r\n                    <div class=\"grid grid-cols-2 md:grid-cols-3 gap-3 mb-6\">\r\n                        <button onclick=\"window._cpmCopilot.generate()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ”‘</span><span>í† í° ìƒì„±</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmCopilot.verify()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">âœ…</span><span>í† í° í™•ì¸</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmCopilot.remove()\" class=\"${BTN_RED_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ—‘ï¸</span><span>í† í° ì œê±°</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmCopilot.models()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“‹</span><span>ëª¨ë¸ ëª©ë¡</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmCopilot.quota()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“Š</span><span>í• ë‹¹ëŸ‰ í™•ì¸</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmCopilot.autoConfig()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">âš™ï¸</span><span>ìžë™ ì„¤ì •</span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    <!-- Result Container -->\r\n                    <div id=\"${PREFIX}-result\" style=\"display:none;\" class=\"space-y-3\"></div>\r\n                `;\r\n            }\r\n        }\r\n    });\r\n\r\n    console.log(`${LOG_TAG} Settings tab registered (v1.5.0) â€” sidebar: ðŸ”‘ Copilot`);\r\n})();\r\n","cpm-translation-cache.js":"//@name CPM Component - Translation Cache Manager\r\n//@display-name Cupcake Translation Cache\r\n//@api 3.0\r\n//@version 1.1.1\r\n//@author Cupcake\r\n//@description ë²ˆì—­ ìºì‹œë¥¼ ê²€ìƒ‰Â·ì¡°íšŒÂ·ìˆ˜ì •í•˜ê³ , ì‚¬ìš©ìž ë²ˆì—­ ì‚¬ì „ìœ¼ë¡œ í‘œì‹œ ë²ˆì—­ì„ êµì •í•˜ëŠ” ê´€ë¦¬ ë„êµ¬ìž…ë‹ˆë‹¤.\r\n//@icon ðŸ’¾\r\n//@update-url https://raw.githubusercontent.com/ruyari-cupcake/cupcake-plugin-manager/main/cpm-translation-cache.js\r\n\r\n/**\r\n * ======== CUPCAKE PM Sub-Plugin: Translation Cache Manager ========\r\n *\r\n * RisuAIì˜ LLM ë²ˆì—­ ìºì‹œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.\r\n *\r\n * ì•„í‚¤í…ì²˜:\r\n *   v3 í”ŒëŸ¬ê·¸ì¸ì€ about:srcdoc ìƒŒë“œë°•ìŠ¤ iframeì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ\r\n *   IndexedDBì— ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (allow-same-origin ì—†ìŒ).\r\n *\r\n *   â†’ ì½ê¸°: risuai.searchTranslationCache / risuai.getTranslationCache\r\n *     (postMessage RPCë¥¼ í†µí•´ ë¶€ëª¨ ìœˆë„ìš°ì—ì„œ ì‹¤í–‰)\r\n *   â†’ ì“°ê¸°: ê³µì‹ APIì— ì—†ìœ¼ë¯€ë¡œ risuai.pluginStorageì—\r\n *     \"ì‚¬ìš©ìž ìˆ˜ì • ì‚¬ì „\" ì˜¤ë²„ë ˆì´ë¥¼ ì €ìž¥í•˜ê³ ,\r\n *     addRisuScriptHandler('display', ...) ë¡œ í‘œì‹œ ì‹œì ì— ì ìš©.\r\n *\r\n * ê¸°ëŠ¥:\r\n *   - RisuAI ë²ˆì—­ ìºì‹œ ê²€ìƒ‰Â·ì¡°íšŒ (API ê²½ìœ , ì½ê¸° ì „ìš©)\r\n *   - ë²ˆì—­ ìˆ˜ì • â†’ ì‚¬ìš©ìž ìˆ˜ì • ì‚¬ì „ì— ì €ìž¥, ì‹¤ì‹œê°„ ë°˜ì˜\r\n *   - ìˆ˜ì • ì‚¬ì „ ê´€ë¦¬ (ì¶”ê°€/ì‚­ì œ/ë˜ëŒë¦¬ê¸°)\r\n *   - ì „ì²´ ë‚´ë³´ë‚´ê¸° (ìºì‹œ + ìˆ˜ì • ì‚¬ì „ ë³‘í•© JSON)\r\n *   - JSON íŒŒì¼ ê°€ì ¸ì˜¤ê¸° (ìˆ˜ì • ì‚¬ì „ì— ë³‘í•©)\r\n *   - ìˆ˜ì • ì‚¬ì „ ì´ˆê¸°í™”\r\n */\r\n(() => {\r\n    if (!window.Risuai && !window.risuai) {\r\n        console.warn('[CPM TransCache] RisuAI API not found. Halting.');\r\n        return;\r\n    }\r\n    const risuai = window.risuai || window.Risuai;\r\n    const CPM = window.CupcakePM;\r\n    if (!CPM) { console.error('[CPM TransCache] CupcakePM API not found!'); return; }\r\n\r\n    // ==========================================\r\n    // Cleanup previous instance (hot-reload)\r\n    // ==========================================\r\n    if (window._cpmTransCacheCleanup) {\r\n        try { window._cpmTransCacheCleanup(); } catch (e) { /* ignore */ }\r\n    }\r\n\r\n    // ==========================================\r\n    // CONSTANTS\r\n    // ==========================================\r\n    const LOG_TAG = '[CPM TransCache]';\r\n    const PREFIX = 'cpm-transcache';\r\n    const CORRECTIONS_KEY = 'cpm_transcache_corrections';\r\n    const ENABLED_ARG_KEY = 'cpm_transcache_display_enabled';\r\n    const PAGE_SIZE = 50;\r\n\r\n    // ==========================================\r\n    // API Feature Detection\r\n    // ==========================================\r\n    const canSearchCache = typeof risuai.searchTranslationCache === 'function';\r\n    const canGetCache = typeof risuai.getTranslationCache === 'function';\r\n    console.log(`${LOG_TAG} API: searchTranslationCache=${canSearchCache}, getTranslationCache=${canGetCache}`);\r\n\r\n    // ==========================================\r\n    // HTML Escape\r\n    // ==========================================\r\n    function escapeHtml(str) {\r\n        if (!str) return '';\r\n        return String(str)\r\n            .replace(/&/g, '&amp;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&#39;');\r\n    }\r\n\r\n    // ==========================================\r\n    // Corrections Storage (pluginStorage)\r\n    // ==========================================\r\n    // Format: { \"original_text\": { old: \"cached_translation\", new: \"corrected_translation\" }, ... }\r\n    let _corrections = {};\r\n\r\n    async function loadCorrections() {\r\n        try {\r\n            const raw = await risuai.pluginStorage.getItem(CORRECTIONS_KEY);\r\n            _corrections = raw ? (typeof raw === 'string' ? JSON.parse(raw) : raw) : {};\r\n        } catch (e) {\r\n            console.error(LOG_TAG, 'loadCorrections error:', e);\r\n            _corrections = {};\r\n        }\r\n        rebuildReplacementMap();\r\n        return _corrections;\r\n    }\r\n\r\n    async function saveCorrections() {\r\n        try {\r\n            await risuai.pluginStorage.setItem(CORRECTIONS_KEY, JSON.stringify(_corrections));\r\n            rebuildReplacementMap();\r\n        } catch (e) {\r\n            console.error(LOG_TAG, 'saveCorrections error:', e);\r\n            throw e;\r\n        }\r\n    }\r\n\r\n    // ==========================================\r\n    // In-memory Replacement Map for Display\r\n    // ==========================================\r\n    // Map<oldTranslation, newTranslation> â€” used by the display handler\r\n    let _replacementMap = new Map();\r\n\r\n    function rebuildReplacementMap() {\r\n        _replacementMap.clear();\r\n        for (const data of Object.values(_corrections)) {\r\n            if (data && data.old && data.new && data.old !== data.new) {\r\n                _replacementMap.set(data.old, data.new);\r\n            }\r\n        }\r\n    }\r\n\r\n    // ==========================================\r\n    // Display Handler â€” applies corrections\r\n    // ==========================================\r\n    let _displayEnabled = true;\r\n\r\n    const displayHandler = (content) => {\r\n        if (!_displayEnabled || _replacementMap.size === 0 || !content) return null;\r\n        let result = content;\r\n        for (const [oldText, newText] of _replacementMap) {\r\n            if (result.includes(oldText)) {\r\n                result = result.split(oldText).join(newText);\r\n            }\r\n        }\r\n        return result === content ? null : result;\r\n    };\r\n\r\n    risuai.addRisuScriptHandler('display', displayHandler);\r\n\r\n    // Cleanup on hot-reload\r\n    window._cpmTransCacheCleanup = () => {\r\n        try { risuai.removeRisuScriptHandler('display', displayHandler); } catch (e) { /* ignore */ }\r\n    };\r\n\r\n    // ==========================================\r\n    // Cache API Wrappers\r\n    // ==========================================\r\n    // In-memory cache of all RisuAI cache entries (loaded on demand)\r\n    let _allCacheEntries = null;\r\n    let _cacheLoadedAt = 0;\r\n    const CACHE_TTL = 120_000; // 2ë¶„\r\n\r\n    async function loadAllCache(force = false) {\r\n        if (!canSearchCache) return null;\r\n        if (!force && _allCacheEntries && (Date.now() - _cacheLoadedAt < CACHE_TTL)) {\r\n            return _allCacheEntries;\r\n        }\r\n        try {\r\n            // searchTranslationCache(\"\") returns ALL entries\r\n            // because every key includes the empty string\r\n            const results = await risuai.searchTranslationCache(\"\");\r\n            _allCacheEntries = results || [];\r\n            _cacheLoadedAt = Date.now();\r\n            return _allCacheEntries;\r\n        } catch (e) {\r\n            console.error(LOG_TAG, 'loadAllCache error:', e);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    async function searchCacheLocal(query) {\r\n        // í•­ìƒ ìµœì‹  ìºì‹œë¥¼ ê°€ì ¸ì˜´ (ìž¬ë²ˆì—­ í›„ stale ë°ì´í„° ë°©ì§€)\r\n        const all = await loadAllCache(true);\r\n        if (!all) return null;\r\n        if (!query) return all;\r\n        const lq = query.toLowerCase();\r\n        return all.filter(entry =>\r\n            entry.key.toLowerCase().includes(lq) ||\r\n            entry.value.toLowerCase().includes(lq)\r\n        );\r\n    }\r\n\r\n    // ==========================================\r\n    // Init: load corrections & enabled state\r\n    // ==========================================\r\n    (async () => {\r\n        try {\r\n            const enabled = await CPM.safeGetArg(ENABLED_ARG_KEY);\r\n            _displayEnabled = (enabled !== 'false' && enabled !== false);\r\n        } catch (e) { /* default true */ }\r\n        await loadCorrections();\r\n        const corrCount = Object.keys(_corrections).length;\r\n        console.log(`${LOG_TAG} Init: ${corrCount} corrections loaded, display=${_displayEnabled}`);\r\n    })();\r\n\r\n    // ==========================================\r\n    // Global API (window callbacks for onclick)\r\n    // ==========================================\r\n    const api = {};\r\n    window._cpmTransCache = api;\r\n\r\n    // State\r\n    let _searchResults = [];\r\n    let _currentPage = 0;\r\n    let _isLoading = false;\r\n\r\n    function setResult(html) {\r\n        const el = document.getElementById(`${PREFIX}-result`);\r\n        if (el) { el.style.display = 'block'; el.innerHTML = html; }\r\n    }\r\n\r\n    function showStatus(msg, type = 'info') {\r\n        const colors = {\r\n            info: 'text-blue-300 border-blue-500',\r\n            success: 'text-green-300 border-green-500',\r\n            error: 'text-red-300 border-red-500',\r\n            warn: 'text-yellow-300 border-yellow-500'\r\n        };\r\n        const c = colors[type] || colors.info;\r\n        setResult(`<div class=\"border-l-4 ${c} pl-4 py-2 text-sm\">${msg}</div>`);\r\n    }\r\n\r\n    // ==========================================\r\n    // Results Rendering\r\n    // ==========================================\r\n    function renderResults(results, page = 0) {\r\n        _searchResults = results;\r\n        _currentPage = page;\r\n        const total = results.length;\r\n        const start = page * PAGE_SIZE;\r\n        const end = Math.min(start + PAGE_SIZE, total);\r\n        const totalPages = Math.ceil(total / PAGE_SIZE);\r\n\r\n        if (total === 0) {\r\n            setResult(`<div class=\"text-gray-400 text-sm py-4 text-center\">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`);\r\n            return;\r\n        }\r\n\r\n        let html = `\r\n            <div class=\"flex items-center justify-between mb-3\">\r\n                <span class=\"text-sm text-gray-400\">ì´ <strong class=\"text-blue-300\">${total}</strong>ê±´ (${start + 1}~${end})</span>\r\n                <div class=\"flex items-center space-x-2\">\r\n                    ${page > 0 ? `<button onclick=\"window._cpmTransCache.goPage(${page - 1})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">â—€ ì´ì „</button>` : ''}\r\n                    <span class=\"text-xs text-gray-500\">${page + 1}/${totalPages}</span>\r\n                    ${end < total ? `<button onclick=\"window._cpmTransCache.goPage(${page + 1})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">ë‹¤ìŒ â–¶</button>` : ''}\r\n                </div>\r\n            </div>\r\n            <div class=\"space-y-2\">\r\n        `;\r\n\r\n        for (let i = start; i < end; i++) {\r\n            const item = results[i];\r\n            const correction = _corrections[item.key];\r\n            // Show corrected translation if exists\r\n            const displayValue = correction ? correction.new : item.value;\r\n            const keyPreview = escapeHtml(item.key.length > 80 ? item.key.substring(0, 80) + 'â€¦' : item.key);\r\n            const valPreview = escapeHtml(displayValue.length > 80 ? displayValue.substring(0, 80) + 'â€¦' : displayValue);\r\n            const badge = correction\r\n                ? '<span class=\"ml-2 px-2 py-0.5 bg-yellow-600/30 text-yellow-300 rounded text-xs\">ìˆ˜ì •ë¨</span>'\r\n                : '';\r\n\r\n            html += `\r\n                <div class=\"bg-gray-800 border ${correction ? 'border-yellow-600/50' : 'border-gray-700'} rounded-lg p-3 hover:border-blue-500 transition-colors\">\r\n                    <div class=\"flex items-start justify-between gap-2\">\r\n                        <div class=\"flex-1 min-w-0\">\r\n                            <div class=\"text-xs text-gray-500 mb-1\">ì›ë¬¸${badge}</div>\r\n                            <div class=\"text-sm text-gray-200 break-words font-mono leading-relaxed\">${keyPreview}</div>\r\n                            <div class=\"text-xs text-gray-500 mt-2 mb-1\">ë²ˆì—­</div>\r\n                            <div class=\"text-sm ${correction ? 'text-yellow-300' : 'text-green-300'} break-words font-mono leading-relaxed\">${valPreview}</div>\r\n                        </div>\r\n                        <div class=\"flex flex-col gap-1 shrink-0\">\r\n                            <button onclick=\"window._cpmTransCache.viewEntry(${i})\" class=\"px-2 py-1 bg-gray-700 hover:bg-blue-600 text-white rounded text-xs\" title=\"ìƒì„¸\">ðŸ”</button>\r\n                            <button onclick=\"window._cpmTransCache.editEntry(${i})\" class=\"px-2 py-1 bg-gray-700 hover:bg-yellow-600 text-white rounded text-xs\" title=\"ìˆ˜ì •\">âœï¸</button>\r\n                            ${correction ? `<button onclick=\"window._cpmTransCache.revertEntry(${i})\" class=\"px-2 py-1 bg-gray-700 hover:bg-orange-600 text-white rounded text-xs\" title=\"ìˆ˜ì • ë˜ëŒë¦¬ê¸°\">â†©ï¸</button>` : ''}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        html += `</div>`;\r\n\r\n        if (totalPages > 1) {\r\n            html += `\r\n                <div class=\"flex items-center justify-center mt-3 space-x-2\">\r\n                    ${page > 0 ? `<button onclick=\"window._cpmTransCache.goPage(${page - 1})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">â—€ ì´ì „</button>` : ''}\r\n                    <span class=\"text-xs text-gray-500\">${page + 1}/${totalPages}</span>\r\n                    ${end < total ? `<button onclick=\"window._cpmTransCache.goPage(${page + 1})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">ë‹¤ìŒ â–¶</button>` : ''}\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        setResult(html);\r\n    }\r\n\r\n    // ==========================================\r\n    // API Methods\r\n    // ==========================================\r\n    api.goPage = (page) => renderResults(_searchResults, page);\r\n\r\n    /** Search RisuAI cache + corrections by keyword */\r\n    api.search = async () => {\r\n        const input = document.getElementById(`${PREFIX}-search-input`);\r\n        const query = input ? input.value.trim() : '';\r\n        if (!query) { showStatus('ê²€ìƒ‰ì–´ë¥¼ ìž…ë ¥í•´ì£¼ì„¸ìš”.', 'warn'); return; }\r\n        if (_isLoading) return;\r\n        _isLoading = true;\r\n        showStatus('ðŸ”„ ê²€ìƒ‰ ì¤‘...');\r\n\r\n        try {\r\n            if (canSearchCache) {\r\n                const results = await searchCacheLocal(query);\r\n                if (results === null) {\r\n                    showStatus('ë²ˆì—­ ìºì‹œ API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');\r\n                } else {\r\n                    renderResults(results);\r\n                }\r\n            } else {\r\n                // Fallback: search corrections only\r\n                const lq = query.toLowerCase();\r\n                const results = Object.entries(_corrections)\r\n                    .filter(([key, data]) =>\r\n                        key.toLowerCase().includes(lq) ||\r\n                        (data.old || '').toLowerCase().includes(lq) ||\r\n                        (data.new || '').toLowerCase().includes(lq)\r\n                    )\r\n                    .map(([key, data]) => ({ key, value: data.old || '' }));\r\n                if (results.length === 0) {\r\n                    showStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (API ë¯¸ì§€ì› â€” ìˆ˜ì • ì‚¬ì „ë§Œ ê²€ìƒ‰)', 'warn');\r\n                } else {\r\n                    renderResults(results);\r\n                }\r\n            }\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'Search error:', err);\r\n            showStatus(`ê²€ìƒ‰ ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        } finally {\r\n            _isLoading = false;\r\n        }\r\n    };\r\n\r\n    /** Browse all cache entries */\r\n    api.browseAll = async () => {\r\n        if (_isLoading) return;\r\n        _isLoading = true;\r\n        showStatus('ðŸ”„ ì „ì²´ ìºì‹œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');\r\n\r\n        try {\r\n            if (canSearchCache) {\r\n                const results = await loadAllCache(true);\r\n                if (results === null) {\r\n                    showStatus('ë²ˆì—­ ìºì‹œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');\r\n                } else if (results.length === 0) {\r\n                    showStatus('ë²ˆì—­ ìºì‹œê°€ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤.', 'warn');\r\n                } else {\r\n                    renderResults(results);\r\n                }\r\n            } else {\r\n                showStatus('searchTranslationCache APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>RisuAI ë²„ì „ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ìˆ˜ì • ì‚¬ì „ ë³´ê¸°ëŠ” ì•„ëž˜ ë²„íŠ¼ ì‚¬ìš©)', 'warn');\r\n            }\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'Browse error:', err);\r\n            showStatus(`ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        } finally {\r\n            _isLoading = false;\r\n        }\r\n    };\r\n\r\n    /** View full entry detail */\r\n    api.viewEntry = (idx) => {\r\n        const item = _searchResults[idx];\r\n        if (!item) return;\r\n        const correction = _corrections[item.key];\r\n        const displayValue = correction ? correction.new : item.value;\r\n        const originalCached = correction ? correction.old : item.value;\r\n\r\n        let correctionInfo = '';\r\n        if (correction) {\r\n            correctionInfo = `\r\n                <div class=\"mb-3 bg-yellow-900/20 border border-yellow-700/50 rounded p-3\">\r\n                    <div class=\"text-xs text-yellow-400 mb-1\">âš ï¸ ì‚¬ìš©ìž ìˆ˜ì • ì ìš©ë¨ (ì›ëž˜ ìºì‹œ ë²ˆì—­:)</div>\r\n                    <div class=\"text-sm text-gray-400 font-mono whitespace-pre-wrap break-words\">${escapeHtml(originalCached)}</div>\r\n                </div>\r\n            `;\r\n        }\r\n\r\n        setResult(`\r\n            <div class=\"bg-gray-800 border border-gray-700 rounded-lg p-4\">\r\n                <div class=\"flex items-center justify-between mb-3\">\r\n                    <h4 class=\"text-blue-300 font-bold text-sm\">ðŸ“„ ìºì‹œ í•­ëª© ìƒì„¸</h4>\r\n                    <button onclick=\"window._cpmTransCache.goPage(${_currentPage})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">â† ëª©ë¡ìœ¼ë¡œ</button>\r\n                </div>\r\n                <div class=\"mb-3\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ì›ë¬¸ (Key)</div>\r\n                    <div class=\"bg-gray-900 border border-gray-600 rounded p-3 text-sm text-gray-200 font-mono whitespace-pre-wrap break-words max-h-60 overflow-y-auto\">${escapeHtml(item.key)}</div>\r\n                </div>\r\n                ${correctionInfo}\r\n                <div>\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ë²ˆì—­ (í˜„ìž¬ í‘œì‹œê°’)</div>\r\n                    <div class=\"bg-gray-900 border border-gray-600 rounded p-3 text-sm ${correction ? 'text-yellow-300' : 'text-green-300'} font-mono whitespace-pre-wrap break-words max-h-60 overflow-y-auto\">${escapeHtml(displayValue)}</div>\r\n                </div>\r\n                <div class=\"flex gap-2 mt-4\">\r\n                    <button onclick=\"window._cpmTransCache.editEntry(${idx})\" class=\"px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-sm font-bold\">âœï¸ ìˆ˜ì •</button>\r\n                    ${correction ? `<button onclick=\"window._cpmTransCache.revertEntry(${idx})\" class=\"px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white rounded text-sm font-bold\">â†©ï¸ ìˆ˜ì • ë˜ëŒë¦¬ê¸°</button>` : ''}\r\n                </div>\r\n            </div>\r\n        `);\r\n    };\r\n\r\n    /** Edit an entry â€” shows editable textarea */\r\n    api.editEntry = (idx) => {\r\n        const item = _searchResults[idx];\r\n        if (!item) return;\r\n        const correction = _corrections[item.key];\r\n        const currentValue = correction ? correction.new : item.value;\r\n\r\n        setResult(`\r\n            <div class=\"bg-gray-800 border border-yellow-600 rounded-lg p-4\">\r\n                <div class=\"flex items-center justify-between mb-3\">\r\n                    <h4 class=\"text-yellow-300 font-bold text-sm\">âœï¸ ë²ˆì—­ ìˆ˜ì •</h4>\r\n                    <button onclick=\"window._cpmTransCache.goPage(${_currentPage})\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\">â† ì·¨ì†Œ</button>\r\n                </div>\r\n                <div class=\"mb-3\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ì›ë¬¸ (Key)</div>\r\n                    <div class=\"bg-gray-900 border border-gray-600 rounded p-3 text-sm text-gray-400 font-mono whitespace-pre-wrap break-words max-h-40 overflow-y-auto\">${escapeHtml(item.key)}</div>\r\n                </div>\r\n                <div class=\"mb-2\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">RisuAI ìºì‹œ ì›ë³¸ ë²ˆì—­ (ì°¸ê³ ìš©)</div>\r\n                    <div class=\"bg-gray-900 border border-gray-700 rounded p-2 text-xs text-gray-500 font-mono whitespace-pre-wrap break-words max-h-24 overflow-y-auto\">${escapeHtml(item.value)}</div>\r\n                </div>\r\n                <div class=\"mb-4\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ìˆ˜ì •í•  ë²ˆì—­ â€” ì•„ëž˜ì—ì„œ íŽ¸ì§‘ í›„ ì €ìž¥</div>\r\n                    <textarea id=\"${PREFIX}-edit-value\" rows=\"6\" class=\"w-full bg-gray-900 border border-yellow-600 rounded p-3 text-sm text-green-300 font-mono focus:border-yellow-400 focus:outline-none resize-y\">${escapeHtml(currentValue)}</textarea>\r\n                </div>\r\n                <p class=\"text-xs text-gray-500 mb-3\">ðŸ’¡ ìˆ˜ì • ë‚´ìš©ì€ ì‚¬ìš©ìž ìˆ˜ì • ì‚¬ì „ì— ì €ìž¥ë˜ë©°, í‘œì‹œ ì‹œ ìžë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>\r\n                <div class=\"flex gap-2\">\r\n                    <button onclick=\"window._cpmTransCache.saveEdit(${idx})\" class=\"px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold\">ðŸ’¾ ì €ìž¥</button>\r\n                    <button onclick=\"window._cpmTransCache.goPage(${_currentPage})\" class=\"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm font-bold\">ì·¨ì†Œ</button>\r\n                </div>\r\n            </div>\r\n        `);\r\n    };\r\n\r\n    /** Save edited entry â†’ corrections dictionary */\r\n    api.saveEdit = async (idx) => {\r\n        const item = _searchResults[idx];\r\n        if (!item) return;\r\n        const textarea = document.getElementById(`${PREFIX}-edit-value`);\r\n        if (!textarea) return;\r\n        const newValue = textarea.value;\r\n\r\n        if (newValue === item.value) {\r\n            // Same as original cache â€” remove correction if exists\r\n            if (_corrections[item.key]) {\r\n                delete _corrections[item.key];\r\n                await saveCorrections();\r\n                showStatus('âœ… ìˆ˜ì •ì´ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤ (ì›ë³¸ê³¼ ë™ì¼).', 'success');\r\n            } else {\r\n                showStatus('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');\r\n            }\r\n            return;\r\n        }\r\n\r\n        try {\r\n            _corrections[item.key] = {\r\n                old: item.value,   // original cached translation\r\n                new: newValue      // user's corrected translation\r\n            };\r\n            await saveCorrections();\r\n            showStatus('âœ… ë²ˆì—­ì´ ìˆ˜ì • ì‚¬ì „ì— ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤. í‘œì‹œ ì‹œ ìžë™ ì ìš©ë©ë‹ˆë‹¤.', 'success');\r\n            updateCorrectionCount();\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'saveEdit error:', err);\r\n            showStatus(`ì €ìž¥ ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Revert a correction back to original */\r\n    api.revertEntry = async (idx) => {\r\n        const item = _searchResults[idx];\r\n        if (!item || !_corrections[item.key]) return;\r\n        if (!confirm('ì´ í•­ëª©ì˜ ìˆ˜ì •ì„ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\\nì›ëž˜ ìºì‹œ ë²ˆì—­ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.')) return;\r\n\r\n        try {\r\n            delete _corrections[item.key];\r\n            await saveCorrections();\r\n            showStatus('âœ… ìˆ˜ì •ì´ ë˜ëŒë ¤ì¡ŒìŠµë‹ˆë‹¤.', 'success');\r\n            updateCorrectionCount();\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'revertEntry error:', err);\r\n            showStatus(`ë˜ëŒë¦¬ê¸° ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Export: merge RisuAI cache + user corrections â†’ JSON */\r\n    api.exportCache = async () => {\r\n        showStatus('ðŸ”„ ë‚´ë³´ë‚´ê¸° ì¤€ë¹„ ì¤‘...');\r\n        try {\r\n            let entries = [];\r\n            if (canSearchCache) {\r\n                const all = await loadAllCache(true);\r\n                if (all) entries = all;\r\n            }\r\n\r\n            // Build merged object: cache entries overridden by corrections\r\n            const obj = {};\r\n            for (const { key, value } of entries) {\r\n                const correction = _corrections[key];\r\n                obj[key] = correction ? correction.new : value;\r\n            }\r\n            // Also include corrections for entries not in cache\r\n            for (const [key, data] of Object.entries(_corrections)) {\r\n                if (!(key in obj)) {\r\n                    obj[key] = data.new;\r\n                }\r\n            }\r\n\r\n            const total = Object.keys(obj).length;\r\n            if (total === 0) {\r\n                showStatus('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn');\r\n                return;\r\n            }\r\n\r\n            const jsonStr = JSON.stringify(obj, null, 2);\r\n            const blob = new Blob([jsonStr], { type: 'application/json' });\r\n            const url = URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            const ts = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n            a.href = url;\r\n            a.download = `risu-translation-cache-${ts}.json`;\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            document.body.removeChild(a);\r\n            URL.revokeObjectURL(url);\r\n            showStatus(`âœ… ${total}ê±´ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤. (ìºì‹œ ${entries.length}ê±´ + ìˆ˜ì • ${Object.keys(_corrections).length}ê±´ ë³‘í•©)`, 'success');\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'Export error:', err);\r\n            showStatus(`ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Export corrections only */\r\n    api.exportCorrections = async () => {\r\n        const corrCount = Object.keys(_corrections).length;\r\n        if (corrCount === 0) {\r\n            showStatus('ë‚´ë³´ë‚¼ ìˆ˜ì • ì‚¬ì „ì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');\r\n            return;\r\n        }\r\n        try {\r\n            // Export as simple { original: correctedTranslation } format\r\n            const obj = {};\r\n            for (const [key, data] of Object.entries(_corrections)) {\r\n                obj[key] = data.new;\r\n            }\r\n            const jsonStr = JSON.stringify(obj, null, 2);\r\n            const blob = new Blob([jsonStr], { type: 'application/json' });\r\n            const url = URL.createObjectURL(blob);\r\n            const a = document.createElement('a');\r\n            const ts = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\r\n            a.href = url;\r\n            a.download = `risu-translation-corrections-${ts}.json`;\r\n            document.body.appendChild(a);\r\n            a.click();\r\n            document.body.removeChild(a);\r\n            URL.revokeObjectURL(url);\r\n            showStatus(`âœ… ìˆ˜ì • ì‚¬ì „ ${corrCount}ê±´ì„ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');\r\n        } catch (err) {\r\n            showStatus(`ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Import JSON into corrections dictionary */\r\n    api.importCache = () => {\r\n        const input = document.createElement('input');\r\n        input.type = 'file';\r\n        input.accept = '.json';\r\n        input.onchange = async (e) => {\r\n            const file = e.target.files[0];\r\n            if (!file) return;\r\n            showStatus('ðŸ”„ íŒŒì¼ì„ ì½ëŠ” ì¤‘...');\r\n\r\n            try {\r\n                const text = await file.text();\r\n                const data = JSON.parse(text);\r\n\r\n                if (typeof data !== 'object' || data === null || Array.isArray(data)) {\r\n                    showStatus('ì˜¬ë°”ë¥¸ ë²ˆì—­ ìºì‹œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ({ ì›ë¬¸: ë²ˆì—­ë¬¸ } ê°ì²´ í•„ìš”)', 'error');\r\n                    return;\r\n                }\r\n                for (const [key, value] of Object.entries(data)) {\r\n                    if (typeof key !== 'string' || typeof value !== 'string') {\r\n                        showStatus('íŒŒì¼ì— ë¬¸ìžì—´ì´ ì•„ë‹Œ í‚¤/ê°’ì´ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤.', 'error');\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                const entryCount = Object.keys(data).length;\r\n                if (!confirm(`${entryCount}ê±´ì„ ìˆ˜ì • ì‚¬ì „ì— ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nê¸°ì¡´ ìˆ˜ì • ì‚¬ì „ì— ë³‘í•©ë©ë‹ˆë‹¤.\\nê°™ì€ ì›ë¬¸ì´ë©´ ìƒˆ ê°’ìœ¼ë¡œ ë®ì–´ì”ë‹ˆë‹¤.`)) return;\r\n\r\n                let added = 0;\r\n                for (const [key, newTranslation] of Object.entries(data)) {\r\n                    // Try to look up original cache value\r\n                    let oldValue = '';\r\n                    if (canGetCache) {\r\n                        try {\r\n                            oldValue = (await risuai.getTranslationCache(key)) || '';\r\n                        } catch (e) { /* ignore */ }\r\n                    }\r\n                    _corrections[key] = {\r\n                        old: oldValue || _corrections[key]?.old || '',\r\n                        new: newTranslation\r\n                    };\r\n                    added++;\r\n                }\r\n                await saveCorrections();\r\n                showStatus(`âœ… ${added}ê±´ì„ ìˆ˜ì • ì‚¬ì „ì— ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.`, 'success');\r\n                updateCorrectionCount();\r\n            } catch (err) {\r\n                console.error(LOG_TAG, 'Import error:', err);\r\n                showStatus(`ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n            }\r\n        };\r\n        input.click();\r\n    };\r\n\r\n    /** Clear all corrections */\r\n    api.clearCorrections = async () => {\r\n        const count = Object.keys(_corrections).length;\r\n        if (count === 0) {\r\n            showStatus('ì‚­ì œí•  ìˆ˜ì • ì‚¬ì „ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warn');\r\n            return;\r\n        }\r\n        if (!confirm(`ìˆ˜ì • ì‚¬ì „ ${count}ê±´ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì›ëž˜ ìºì‹œ ë²ˆì—­ìœ¼ë¡œ ë³µì›ë©ë‹ˆë‹¤.`)) return;\r\n\r\n        try {\r\n            _corrections = {};\r\n            await saveCorrections();\r\n            showStatus(`âœ… ìˆ˜ì • ì‚¬ì „ ${count}ê±´ì„ ëª¨ë‘ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`, 'success');\r\n            updateCorrectionCount();\r\n        } catch (err) {\r\n            showStatus(`ì‚­ì œ ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Browse corrections only */\r\n    api.browseCorrections = async () => {\r\n        await loadCorrections();\r\n        const results = Object.entries(_corrections).map(([key, data]) => ({\r\n            key,\r\n            value: data.old || ''\r\n        }));\r\n        if (results.length === 0) {\r\n            showStatus('ìˆ˜ì • ì‚¬ì „ì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤.', 'warn');\r\n            return;\r\n        }\r\n        renderResults(results);\r\n    };\r\n\r\n    /** Add new entry manually to corrections */\r\n    api.showAddForm = () => {\r\n        setResult(`\r\n            <div class=\"bg-gray-800 border border-green-600 rounded-lg p-4\">\r\n                <h4 class=\"text-green-300 font-bold text-sm mb-3\">âž• ìˆ˜ë™ìœ¼ë¡œ ë²ˆì—­ ì¶”ê°€</h4>\r\n                <div class=\"mb-3\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ì›ë¬¸ (ë²ˆì—­ ì „ í…ìŠ¤íŠ¸)</div>\r\n                    <textarea id=\"${PREFIX}-add-key\" rows=\"3\" class=\"w-full bg-gray-900 border border-gray-600 rounded p-3 text-sm text-gray-200 font-mono focus:border-green-400 focus:outline-none resize-y\" placeholder=\"ë²ˆì—­ ì „ ì›ë¬¸ì„ ìž…ë ¥í•˜ì„¸ìš”...\"></textarea>\r\n                </div>\r\n                <div class=\"mb-4\">\r\n                    <div class=\"text-xs text-gray-500 mb-1\">ë²ˆì—­ (í‘œì‹œí•  í…ìŠ¤íŠ¸)</div>\r\n                    <textarea id=\"${PREFIX}-add-value\" rows=\"3\" class=\"w-full bg-gray-900 border border-gray-600 rounded p-3 text-sm text-green-300 font-mono focus:border-green-400 focus:outline-none resize-y\" placeholder=\"ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë¥¼ ìž…ë ¥í•˜ì„¸ìš”...\"></textarea>\r\n                </div>\r\n                <p class=\"text-xs text-gray-500 mb-3\">ðŸ’¡ ìˆ˜ì • ì‚¬ì „ì— ì¶”ê°€ë©ë‹ˆë‹¤. í•´ë‹¹ ì›ë¬¸ì˜ ìºì‹œ ë²ˆì—­ì´ ìžˆìœ¼ë©´ ì´ ê°’ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.</p>\r\n                <div class=\"flex gap-2\">\r\n                    <button onclick=\"window._cpmTransCache.saveNewEntry()\" class=\"px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded text-sm font-bold\">ðŸ’¾ ì¶”ê°€</button>\r\n                    <button onclick=\"window._cpmTransCache.goPage(${_currentPage})\" class=\"px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded text-sm font-bold\">ì·¨ì†Œ</button>\r\n                </div>\r\n            </div>\r\n        `);\r\n    };\r\n\r\n    api.saveNewEntry = async () => {\r\n        const keyEl = document.getElementById(`${PREFIX}-add-key`);\r\n        const valEl = document.getElementById(`${PREFIX}-add-value`);\r\n        if (!keyEl || !valEl) return;\r\n\r\n        const key = keyEl.value;\r\n        const value = valEl.value;\r\n        if (!key.trim()) { showStatus('ì›ë¬¸ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.', 'warn'); return; }\r\n        if (!value.trim()) { showStatus('ë²ˆì—­ì„ ìž…ë ¥í•´ì£¼ì„¸ìš”.', 'warn'); return; }\r\n\r\n        try {\r\n            let oldValue = '';\r\n            if (canGetCache) {\r\n                try { oldValue = (await risuai.getTranslationCache(key)) || ''; } catch (e) { /* ignore */ }\r\n            }\r\n            if (_corrections[key]) {\r\n                if (!confirm('ì´ë¯¸ ìˆ˜ì • ì‚¬ì „ì— ë™ì¼í•œ ì›ë¬¸ì´ ìžˆìŠµë‹ˆë‹¤. ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;\r\n            }\r\n            _corrections[key] = {\r\n                old: oldValue || _corrections[key]?.old || '',\r\n                new: value\r\n            };\r\n            await saveCorrections();\r\n            showStatus('âœ… ìˆ˜ì • ì‚¬ì „ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');\r\n            updateCorrectionCount();\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'saveNewEntry error:', err);\r\n            showStatus(`ì¶”ê°€ ì˜¤ë¥˜: ${escapeHtml(err.message)}`, 'error');\r\n        }\r\n    };\r\n\r\n    /** Toggle display corrections on/off */\r\n    api.toggleDisplay = async (checkbox) => {\r\n        _displayEnabled = checkbox.checked;\r\n        CPM.setArg(ENABLED_ARG_KEY, _displayEnabled);\r\n    };\r\n\r\n    /** Refresh counts */\r\n    api.refreshCount = async () => {\r\n        try {\r\n            if (canSearchCache) {\r\n                const all = await loadAllCache(true);\r\n                const el = document.getElementById(`${PREFIX}-cache-count`);\r\n                if (el && all) el.textContent = `${all.length.toLocaleString()}ê±´`;\r\n            }\r\n        } catch (err) {\r\n            console.error(LOG_TAG, 'refreshCount error:', err);\r\n        }\r\n        updateCorrectionCount();\r\n    };\r\n\r\n    function updateCorrectionCount() {\r\n        const el = document.getElementById(`${PREFIX}-corr-count`);\r\n        if (el) el.textContent = `${Object.keys(_corrections).length.toLocaleString()}ê±´`;\r\n    }\r\n\r\n    api.onSearchKeydown = (event) => {\r\n        if (event.key === 'Enter') { event.preventDefault(); api.search(); }\r\n    };\r\n\r\n    // ==========================================\r\n    // REGISTER SETTINGS TAB\r\n    // ==========================================\r\n    const BTN_CLASS = 'flex flex-col items-center justify-center p-3 rounded-lg bg-gray-800 hover:bg-blue-600 text-gray-200 transition-colors border border-gray-700 cursor-pointer text-sm font-medium';\r\n    const BTN_WARN_CLASS = 'flex flex-col items-center justify-center p-3 rounded-lg bg-gray-800 hover:bg-orange-600 text-gray-200 transition-colors border border-gray-700 cursor-pointer text-sm font-medium';\r\n    const BTN_RED_CLASS = 'flex flex-col items-center justify-center p-3 rounded-lg bg-gray-800 hover:bg-red-600 text-gray-200 transition-colors border border-gray-700 cursor-pointer text-sm font-medium';\r\n\r\n    CPM.registerProvider({\r\n        name: 'TranslationCache',\r\n        settingsTab: {\r\n            id: 'tab-transcache',\r\n            icon: 'ðŸ’¾',\r\n            label: 'ë²ˆì—­ ìºì‹œ',\r\n            exportKeys: [ENABLED_ARG_KEY],\r\n            renderContent: async (renderInput) => {\r\n                // Pre-fetch counts\r\n                let cacheCount = 'â€”';\r\n                const corrCount = Object.keys(_corrections).length.toLocaleString() + 'ê±´';\r\n\r\n                if (canSearchCache) {\r\n                    try {\r\n                        const all = await loadAllCache();\r\n                        cacheCount = all ? `${all.length.toLocaleString()}ê±´` : '(ì˜¤ë¥˜)';\r\n                    } catch { cacheCount = '(ì˜¤ë¥˜)'; }\r\n                } else {\r\n                    cacheCount = '(API ë¯¸ì§€ì›)';\r\n                }\r\n\r\n                const displayChecked = _displayEnabled ? 'checked' : '';\r\n\r\n                return `\r\n                    <h3 class=\"text-3xl font-bold text-blue-400 mb-6 pb-3 border-b border-gray-700\">ðŸ’¾ ë²ˆì—­ ìºì‹œ ê´€ë¦¬ìž</h3>\r\n                    <p class=\"text-blue-300 font-semibold mb-4 border-l-4 border-blue-500 pl-4 py-1\">\r\n                        RisuAI ë²ˆì—­ ìºì‹œë¥¼ ê²€ìƒ‰Â·í™•ì¸í•˜ê³ , ì‚¬ìš©ìž ìˆ˜ì • ì‚¬ì „ìœ¼ë¡œ ë²ˆì—­ì„ êµì •í•©ë‹ˆë‹¤.\r\n                    </p>\r\n                    <p class=\"text-xs text-gray-500 mb-6\">\r\n                        â„¹ï¸ RisuAI ìºì‹œëŠ” ì½ê¸° ì „ìš©ìž…ë‹ˆë‹¤. ë²ˆì—­ ìˆ˜ì • ì‹œ \"ìˆ˜ì • ì‚¬ì „\"ì— ì €ìž¥ë˜ë©°, ì±„íŒ… í‘œì‹œ ì‹œì ì— ìžë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.\r\n                    </p>\r\n\r\n                    <!-- Display Toggle -->\r\n                    <div class=\"mb-4\">\r\n                        <label class=\"flex items-center space-x-2 text-sm font-medium text-gray-300\">\r\n                            <input id=\"${PREFIX}-display-toggle\" type=\"checkbox\" ${displayChecked}\r\n                                   onchange=\"window._cpmTransCache.toggleDisplay(this)\"\r\n                                   class=\"form-checkbox text-blue-500 rounded bg-gray-800 border-gray-600 focus:ring-blue-500\">\r\n                            <span>ìˆ˜ì • ì‚¬ì „ ìžë™ ì ìš© (ì±„íŒ… í‘œì‹œ ì‹œ ë²ˆì—­ êµì •)</span>\r\n                        </label>\r\n                    </div>\r\n\r\n                    <!-- Stats -->\r\n                    <div class=\"mb-6 bg-gray-800 border border-gray-700 rounded-lg p-4\">\r\n                        <div class=\"flex items-center justify-between mb-2\">\r\n                            <div>\r\n                                <span class=\"text-sm text-gray-400\">RisuAI ë²ˆì—­ ìºì‹œ:</span>\r\n                                <span id=\"${PREFIX}-cache-count\" class=\"text-sm font-bold text-blue-300 ml-2\">${cacheCount}</span>\r\n                            </div>\r\n                            <button onclick=\"window._cpmTransCache.refreshCount()\" class=\"px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-xs\" title=\"ìƒˆë¡œê³ ì¹¨\">ðŸ”„</button>\r\n                        </div>\r\n                        <div>\r\n                            <span class=\"text-sm text-gray-400\">ì‚¬ìš©ìž ìˆ˜ì • ì‚¬ì „:</span>\r\n                            <span id=\"${PREFIX}-corr-count\" class=\"text-sm font-bold text-yellow-300 ml-2\">${corrCount}</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <!-- Search -->\r\n                    <div class=\"mb-4\">\r\n                        <label class=\"block text-sm font-medium text-gray-400 mb-2\">ðŸ” ê²€ìƒ‰ (ì›ë¬¸ + ë²ˆì—­ë¬¸ ëª¨ë‘ ê²€ìƒ‰)</label>\r\n                        <div class=\"flex items-center space-x-2\">\r\n                            <input id=\"${PREFIX}-search-input\" type=\"text\" placeholder=\"ê²€ìƒ‰ì–´ë¥¼ ìž…ë ¥í•˜ì„¸ìš”...\"\r\n                                   class=\"flex-1 bg-gray-800 border border-gray-600 rounded px-3 py-2 text-gray-200 text-sm focus:border-blue-500 focus:outline-none\"\r\n                                   onkeydown=\"window._cpmTransCache.onSearchKeydown(event)\" />\r\n                            <button onclick=\"window._cpmTransCache.search()\" class=\"bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-bold shrink-0\">ðŸ” ê²€ìƒ‰</button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <!-- Action Buttons -->\r\n                    <div class=\"grid grid-cols-2 md:grid-cols-3 gap-3 mb-3\">\r\n                        <button onclick=\"window._cpmTransCache.browseAll()\" class=\"${BTN_CLASS}\" ${!canSearchCache ? 'disabled title=\"API ë¯¸ì§€ì›\"' : ''}>\r\n                            <span class=\"text-2xl mb-1\">ðŸ“‹</span><span>ìºì‹œ ì „ì²´ ë³´ê¸°</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmTransCache.browseCorrections()\" class=\"${BTN_WARN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“</span><span>ìˆ˜ì • ì‚¬ì „ ë³´ê¸°</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmTransCache.showAddForm()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">âž•</span><span>ìˆ˜ë™ ì¶”ê°€</span>\r\n                        </button>\r\n                    </div>\r\n                    <div class=\"grid grid-cols-2 md:grid-cols-3 gap-3 mb-6\">\r\n                        <button onclick=\"window._cpmTransCache.exportCache()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“¤</span><span>ì „ì²´ ë‚´ë³´ë‚´ê¸°</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmTransCache.exportCorrections()\" class=\"${BTN_WARN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“¤</span><span>ìˆ˜ì • ì‚¬ì „ ë‚´ë³´ë‚´ê¸°</span>\r\n                        </button>\r\n                        <button onclick=\"window._cpmTransCache.importCache()\" class=\"${BTN_CLASS}\">\r\n                            <span class=\"text-2xl mb-1\">ðŸ“¥</span><span>ê°€ì ¸ì˜¤ê¸°</span>\r\n                        </button>\r\n                    </div>\r\n                    <div class=\"grid grid-cols-1 gap-3 mb-6\">\r\n                        <button onclick=\"window._cpmTransCache.clearCorrections()\" class=\"${BTN_RED_CLASS}\">\r\n                            <span class=\"text-lg\">ðŸ—‘ï¸ ìˆ˜ì • ì‚¬ì „ ì „ì²´ ì‚­ì œ</span>\r\n                        </button>\r\n                    </div>\r\n\r\n                    <!-- Result Container -->\r\n                    <div id=\"${PREFIX}-result\" style=\"display:none;\" class=\"space-y-3\"></div>\r\n                `;\r\n            }\r\n        }\r\n    });\r\n\r\n    console.log(`${LOG_TAG} Translation Cache Manager v1.1.1 registered â€” sidebar: ðŸ’¾ ë²ˆì—­ ìºì‹œ`);\r\n})();\r\n"}}